<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Family Budget Buddy</title>
<style>
:root{--bg:#0b1020;--p:#0f1832;--p2:#101c3a;--t:#eef2ff;--m:#b7c1ff;--a:#7c5cff;--g:#22c55e;--good:#22c55e;--w:#f59e0b;--b:#ef4444;--l:rgba(255,255,255,.12);--sh:0 16px 45px rgba(0,0,0,.35);--r:18px;--bad:var(--b)}
*{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1100px 700px at 20% -10%,rgba(124,92,255,.35),transparent 55%),radial-gradient(900px 600px at 95% 10%,rgba(34,197,94,.18),transparent 55%),linear-gradient(180deg,#070a14,var(--bg) 30%,#070a14);color:var(--t)}
a{color:inherit}button,input,select{font:inherit}
.top{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.72);backdrop-filter:blur(10px);border-bottom:1px solid var(--l)}
.wrap{max-width:1120px;margin:0 auto;padding:14px 16px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:42px;height:42px;border-radius:14px;background:conic-gradient(from 180deg at 50% 50%,#22c55e,#7c5cff,#f59e0b,#22c55e);box-shadow:0 12px 30px rgba(124,92,255,.25)}
.h1{font-weight:900;letter-spacing:.2px}.sub{color:var(--m);font-size:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin-top:10px}
.pill{display:flex;gap:10px;align-items:center;padding:10px 12px;border:1px solid var(--l);background:rgba(15,24,50,.6);border-radius:999px}
.pill b{font-size:13px}
.small{font-size:12px;color:var(--m)}
.btn{border:1px solid var(--l);background:linear-gradient(180deg,rgba(124,92,255,.22),rgba(124,92,255,.08));color:var(--t);padding:10px 12px;border-radius:12px;cursor:pointer;box-shadow:var(--sh);transition:.15s transform,.15s filter}
.btn:hover{transform:translateY(-1px);filter:brightness(1.08)}
.btn.ghost{background:rgba(16,28,58,.55)}
.btn.good{background:linear-gradient(180deg,rgba(34,197,94,.22),rgba(34,197,94,.07))}
.btn.bad{background:linear-gradient(180deg,rgba(239,68,68,.22),rgba(239,68,68,.07))}
.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;margin:16px auto;max-width:1120px;padding:0 16px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(16,28,58,.75),rgba(15,24,50,.65));border:1px solid var(--l);border-radius:var(--r);box-shadow:var(--sh)}
.card h2{margin:0;padding:14px 14px 0;font-size:16px}
.card .pad{padding:14px}
.tabs{display:flex;gap:8px;flex-wrap:wrap;padding:12px 14px 0}
.tab{padding:8px 10px;border-radius:999px;border:1px solid var(--l);background:rgba(15,24,50,.55);cursor:pointer;font-size:12px;color:var(--m)}
.tab.on{background:rgba(124,92,255,.22);color:var(--t);border-color:rgba(124,92,255,.45)}
hr{border:0;border-top:1px solid var(--l);margin:12px 0}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-size:12px;color:var(--m);text-align:left;padding:0 10px}
.tr{background:rgba(15,24,50,.55);border:1px solid var(--l);border-radius:14px}
.tr td{padding:10px}
.tr td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
.tr td:last-child{border-top-right-radius:14px;border-bottom-right-radius:14px}
.in{width:100%;padding:10px 10px;border:1px solid rgba(255,255,255,.15);background:rgba(5,8,18,.55);color:var(--t);border-radius:12px;outline:none}
.in:focus{border-color:rgba(124,92,255,.6);box-shadow:0 0 0 4px rgba(124,92,255,.18)}
.sel{appearance:none}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media (max-width:700px){.kpis{grid-template-columns:1fr}}
.kpi{padding:12px;border-radius:18px;border:1px solid var(--l);background:rgba(15,24,50,.55)}
.kpi .lab{font-size:12px;color:var(--m)}
.kpi .val{font-size:20px;font-weight:900;margin-top:4px}
.badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--l);background:rgba(15,24,50,.55);font-size:12px;color:var(--m)}
.dot{width:10px;height:10px;border-radius:999px;background:var(--a);box-shadow:0 0 0 4px rgba(124,92,255,.18)}
.canvas{width:100%;height:240px;background:rgba(5,8,18,.35);border:1px dashed rgba(255,255,255,.18);border-radius:18px}
.footer{max-width:1120px;margin:0 auto;padding:10px 16px 28px;color:rgba(183,193,255,.9);font-size:12px}
.toast{position:fixed;right:16px;bottom:16px;max-width:360px;z-index:9999}
.toast .t{margin-top:10px;padding:12px 14px;border-radius:16px;border:1px solid var(--l);background:rgba(16,28,58,.9);box-shadow:var(--sh)}
</style>
</head>
<body>
<div class="top">
  <div class="wrap">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="h1">Family Budget Buddy</div>
        <div class="sub">A friendly, fully-editable budget + mortgage planner (saved locally in your browser)</div>
      </div>
    </div>
    <div class="row">
      <div class="pill">
        <b>Month</b>
        <select id="monthSel" class="in sel" style="width:220px"></select>
        <button class="btn ghost" id="addMonthBtn" title="Add a new month">+ Month</button>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn ghost" id="importBtn">Import</button>
        <button class="btn ghost" id="exportBtn">Export</button>
        <button class="btn bad" id="resetBtn">Reset</button>
      </div>
    </div>
  </div>
</div>

<div class="grid">
  <div class="card">
    <div class="tabs" id="tabs"></div>
    <h2 id="tabTitle">Dashboard</h2>
    <div class="pad" id="tabBody"></div>
  </div>

  <div class="card">
    <h2>Quick Summary</h2>
    <div class="pad">
      <div class="kpis">
        <div class="kpi"><div class="lab">Total income (this month)</div><div class="val" id="kIncome">$0</div></div>
        <div class="kpi"><div class="lab">Total expenses (this month)</div><div class="val" id="kExp">$0</div></div>
        <div class="kpi"><div class="lab">Net cashflow (income - expenses)</div><div class="val" id="kNet">$0</div></div>
      </div>
      <hr>
      <div class="badge"><span class="dot"></span><span id="hint">Tip: Everything is editable. Add rows, rename categories, and export a backup any time.</span></div>
      <hr>
      <h2 style="padding:0;margin:0 0 8px;font-size:14px">Charts</h2>
      <canvas id="pie" class="canvas" width="900" height="520"></canvas>
      <div class="small" style="margin-top:8px">Expense breakdown (planned/actual). Edit your rows to update the chart.</div>
      <hr>
      <canvas id="bars" class="canvas" width="900" height="520"></canvas>
      <div class="small" style="margin-top:8px">12-month net cashflow (if you have multiple months).</div>
    </div>
  </div>
</div>

<div class="footer">Works offline. Data is stored in your browser (localStorage). Use <b>Export</b> for backups and to move to another computer.</div>
<div class="toast" id="toast"></div>

<input id="filePick" type="file" accept="application/json" style="display:none" />

<script>
(async()=>{
  const $=s=>document.querySelector(s);
  const fmt=n=>{
    const v=Number(n||0);
    const sign=v<0?"-":"";
    return sign+v.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
  };
  const num=v=>{
    if(v===null||v===undefined) return 0;
    if(typeof v==='number') return isFinite(v)?v:0;
    const x=String(v).replace(/[^0-9.-]/g,'');
    const n=Number(x);
    return isFinite(n)?n:0;
  };
  const uid=()=>Math.random().toString(36).slice(2,10);

  const KEY='family_budget_buddy_v1';
  const today=()=>{
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`; // YYYY-MM
  };
  const monthLabel=ym=>{
    const [y,m]=ym.split('-').map(Number);
    const d=new Date(y,m-1,1);
    return d.toLocaleString(undefined,{month:'long',year:'numeric'});
  };

  const defaultMonth=(ym)=>({
    id:ym,
    name:monthLabel(ym),
    notes:'',
    incomes:[
      {id:uid(), name:'Paycheck 1', category:'Wages', planned:2500, actual:2500, when:'Recurring'},
      {id:uid(), name:'Paycheck 2', category:'Wages', planned:2500, actual:2500, when:'Recurring'},
    ],
    expenses:[
      {id:uid(), name:'Groceries', category:'Food', planned:600, actual:600, when:'Recurring'},
      {id:uid(), name:'Utilities', category:'Bills', planned:280, actual:280, when:'Recurring'},
      {id:uid(), name:'Gas', category:'Transport', planned:180, actual:180, when:'Recurring'},
      {id:uid(), name:'Fun / Eating out', category:'Lifestyle', planned:150, actual:150, when:'Flexible'},
    ],
    mortgage:{
      homePrice:350000,
      downPayment:70000,
      interestRate:6.25,
      termYears:30,
      startDate: ym+"-01",
      propertyTaxMonthly:350,
      insuranceMonthly:120,
      hoaMonthly:0,
      extraMonthly:0,
      extraOneTime:0,
      extraOneTimeMonth: ym,
    },
    autoLoan:{
      loanAmount:25000,
      interestRate:7.25,
      termMonths:72,
      startDate: ym+"-01",
      extraMonthly:0,
      extraOneTime:0,
      extraOneTimeMonth: ym,
    },
    customSections:[
      {id:uid(), title:'Savings Goals', rows:[
        {id:uid(), name:'Emergency Fund', planned:300, actual:300, note:''},
        {id:uid(), name:'Vacation', planned:150, actual:150, note:''}
      ]}
    ]
  });

  let state = load();
  let loadedFromJson = false;
  const params = new URLSearchParams(location.search);
  const forceJson = (params.get('source')==='json' || params.get('source')==='budget.json');
  if(!state || forceJson){
    const js = await tryLoadJson();
    if(js){ state = js; loadedFromJson = true; }
    if(!state) state = seed();
  }
  // Preferences
  state.settings = state.settings || {universalIncome:false, universalExpenses:false, includeMortgageExpense:true, includeAutoLoanExpense:true};
  if(typeof state.settings.universalIncome!=='boolean') state.settings.universalIncome=false;
  if(typeof state.settings.universalExpenses!=='boolean') state.settings.universalExpenses=false;
  if(typeof state.settings.includeMortgageExpense!=='boolean') state.settings.includeMortgageExpense=true;
  if(typeof state.settings.includeAutoLoanExpense!=='boolean') state.settings.includeAutoLoanExpense=true;


  // --- Data normalization / migration (prevents older saved data from breaking new features) ---
  function normalizeRow(r){
    r = r || {};
    if(!r.id) r.id=uid();
    if(r.name===undefined) r.name='';
    if(r.category===undefined) r.category='';
    if(r.when===undefined) r.when='';
    if(r.planned===undefined) r.planned=0;
    if(r.actual===undefined) r.actual=0;
    return r;
  }

  function normalizeCustomRow(r){
    r = r || {};
    if(!r.id) r.id=uid();
    if(r.name===undefined) r.name='';
    if(r.planned===undefined) r.planned=0;
    if(r.actual===undefined) r.actual=0;
    if(r.note===undefined) r.note='';
    return r;
  }

  function normalizeMonthObj(mo, ym){
    mo = mo || {};
    // core
    mo.id = mo.id || ym;
    mo.name = mo.name || monthLabel(ym);
    if(!Array.isArray(mo.incomes)) mo.incomes=[];
    if(!Array.isArray(mo.expenses)) mo.expenses=[];
    mo.incomes = mo.incomes.map(normalizeRow);
    mo.expenses = mo.expenses.map(normalizeRow);

    // mortgage defaults (merge)
    const d=defaultMonth(ym);
    mo.mortgage = Object.assign({}, d.mortgage, (mo.mortgage||{}));
    mo.autoLoan = Object.assign({}, d.autoLoan, (mo.autoLoan||{}));
    // new guideline fields
    if(mo.mortgage.incomeBasis===undefined) mo.mortgage.incomeBasis='actual';
    if(mo.mortgage.imputedIncomeMonthly===undefined) mo.mortgage.imputedIncomeMonthly='';
    if(mo.mortgage.otherDebtMonthly===undefined) mo.mortgage.otherDebtMonthly=0;

    // custom sections
    if(!Array.isArray(mo.customSections)) mo.customSections=[];
    mo.customSections = mo.customSections.map(sec=>{
      sec = sec || {};
      if(!sec.id) sec.id=uid();
      if(sec.title===undefined) sec.title='Section';
      if(!Array.isArray(sec.rows)) sec.rows=[];
      sec.rows = sec.rows.map(normalizeCustomRow);
      return sec;
    });
    // ensure at least one example section exists for first-time users
    if(mo.customSections.length==0){
      mo.customSections = d.customSections;
    }

    // documents (receipts/invoices)
    if(!Array.isArray(mo.documents)) mo.documents=[];

    return mo;
  }

  function normalizeState(){
    if(!state || typeof state!=='object') return;
    if(!state.months || typeof state.months!=='object') state.months={};
    if(!state.currentMonthId) state.currentMonthId = today();
    for(const ym of Object.keys(state.months)){
      state.months[ym]=normalizeMonthObj(state.months[ym], ym);
    }
    // ensure current month exists
    const cur=state.currentMonthId;
    if(!state.months[cur]) state.months[cur]=defaultMonth(cur);
    state.months[cur]=normalizeMonthObj(state.months[cur], cur);
  }

  normalizeState();
  try{ save(); }catch(e){}
  let currentMonthId=state.currentMonthId;
  const tabs=[
    {id:'dash', label:'Dashboard'},
    {id:'income', label:'Income'},
    {id:'exp', label:'Expenses'},
    {id:'auto', label:'Auto Loan'},
    {id:'mort', label:'Mortgage'},
    {id:'custom', label:'Custom'},
    {id:'docs', label:'Documents'}
  ];
  let activeTab='dash';


  async function tryLoadJson(){
    try{
      const res = await fetch('budget.json', {cache:'no-store'});
      if(!res.ok) return null;
      const obj = await res.json();
      if(!obj || !obj.months) return null;
      obj.version = obj.version || 1;
      obj.currentMonthId = obj.currentMonthId || Object.keys(obj.months).sort()[0];
      obj.settings = obj.settings || {universalIncome:false, universalExpenses:false, includeMortgageExpense:true, includeAutoLoanExpense:true};
      for(const mo of Object.values(obj.months)){
        mo.incomes = mo.incomes || [];
        mo.expenses = mo.expenses || [];
        mo.mortgage = mo.mortgage || {};
        mo.autoLoan = mo.autoLoan || {};
        mo.customSections = mo.customSections || [];
        mo.documents = mo.documents || [];
        const fixRow = (r)=>{
          r.id = r.id || uid();
          r.name = r.name || 'Item';
          r.category = r.category || 'Other';
          r.when = r.when || 'Recurring';
          r.planned = (r.planned==null)?0:r.planned;
          r.actual = (r.actual==null)?0:r.actual;
        };
        mo.incomes.forEach(fixRow);
        mo.expenses.forEach(fixRow);
        mo.customSections.forEach(sec=>{
          sec.id = sec.id || uid();
          sec.title = sec.title || 'Section';
          sec.rows = sec.rows || [];
          sec.rows.forEach(rr=>{
            rr.id = rr.id || uid();
            rr.name = rr.name || 'Item';
            rr.planned = (rr.planned==null)?0:rr.planned;
            rr.actual = (rr.actual==null)?0:rr.actual;
            rr.note = rr.note || '';
          });
        });
      }
      localStorage.setItem(KEY, JSON.stringify(obj));
      return obj;
    }catch(e){
      console.warn('budget.json load failed', e);
      return null;
    }
  }

  function seed(){
    const ym=today();
    const s={version:1, currentMonthId:ym, months:{}};
    s.months[ym]=defaultMonth(ym);
    save(s);
    return s;
  }

  function load(){
    try{const raw=localStorage.getItem(KEY); return raw?JSON.parse(raw):null;}catch{return null}
  }
  function save(s=state){
    localStorage.setItem(KEY, JSON.stringify(s));
  }

  function toast(msg){
    const box=$('#toast');
    const d=document.createElement('div');
    d.className='t';
    d.textContent=msg;
    box.appendChild(d);
    setTimeout(()=>{d.style.opacity='0'; d.style.transform='translateY(6px)'; d.style.transition='200ms';},2200);
    setTimeout(()=>d.remove(),2600);
  }

  if(loadedFromJson) toast('Loaded budget.json');

  function ensureMonth(ym){
    if(!state.months[ym]) state.months[ym]=defaultMonth(ym);
  }

  function current(){
    ensureMonth(currentMonthId);
    return state.months[currentMonthId];
  }

  function clone(obj){return JSON.parse(JSON.stringify(obj));}

  function propagateRow(kind, rowId, mut){
    for(const mo of Object.values(state.months)){
      const arr = (kind==='income') ? mo.incomes : mo.expenses;
      const r = arr.find(x=>x.id===rowId);
      if(r) mut(r, arr, mo);
    }
  }

  function addRowAllMonths(kind, row){
    for(const mo of Object.values(state.months)){
      const arr = (kind==='income') ? mo.incomes : mo.expenses;
      if(!arr.some(x=>x.id===row.id)) arr.push(clone(row));
    }
  }

  function removeRowAllMonths(kind, rowId){
    for(const mo of Object.values(state.months)){
      const arr = (kind==='income') ? mo.incomes : mo.expenses;
      const idx = arr.findIndex(x=>x.id===rowId);
      if(idx>=0) arr.splice(idx,1);
    }
  }

  function syncMortgageExpense(monthObj){
    if(!state.settings.includeMortgageExpense) return;
    const mo = monthObj.mortgage || {};
    const mt = mortgageTotals(mo);
    const amt = Math.round(mt.totalWithExtra||0);
    const name = 'Mortgage (monthly outflow)';
    const cat = 'Housing';
    let row = monthObj.expenses.find(x=>x.name===name && x.category===cat);
    if(!row){
      row = {id:uid(), name, category:cat, when:'Recurring', planned:amt, actual:amt};
      monthObj.expenses.push(row);
    }else{
      row.planned = amt;
      row.actual = amt;
      row.when = row.when || 'Recurring';
    }
  }

  function syncAutoLoanExpense(monthObj){
    if(!state.settings.includeAutoLoanExpense) return;
    const name = "Auto Loan (monthly outflow)";
    const cat = "Transportation";
    const applyAll = !!state.settings.universalExpenses;
    const targets = applyAll ? Object.values(state.months) : [monthObj];
    for(const mo of targets){
      const ao = mo.autoLoan || {};
      const at = autoLoanTotals(ao);
      const amt = Math.round(at.totalWithExtra||0);
      let row = (mo.expenses||[]).find(x=>x.name===name && x.category===cat);
      if(!row){
        row = {id:uid(), name, category:cat, when:"Recurring", planned:amt, actual:amt};
        mo.expenses.push(row);
      }else{
        row.planned = amt;
        row.actual = amt;
        row.when = row.when || "Recurring";
      }
    }
  }

  function setMonth(ym){
    ensureMonth(ym);
    currentMonthId=ym;
    state.currentMonthId=ym;
    save();
    renderAll();
  }

  function sumRows(rows, field){
    return rows.reduce((a,r)=>a+num(r[field]),0);
  }


  function sumCustom(monthObj, field){
    let s=0;
    (monthObj.customSections||[]).forEach(sec=>{
      (sec.rows||[]).forEach(r=>{
        s += Math.max(0, num(r[field])||0);
      });
    });
    return s;
  }

  // Convenience helper (used by the 28/36 guideline panel)
  function totalIncome(monthObj, basis){
    const m = monthObj || current();
    const b = (basis==='planned' || basis==='actual') ? basis : 'actual';
    return sumRows((m.incomes || []), b);
  }

  function totals(){
    const m=current();
    const incA=sumRows(m.incomes,'actual');
    const expA=sumRows(m.expenses,'actual') + sumCustom(m,'actual');
    const incP=sumRows(m.incomes,'planned');
    const expP=sumRows(m.expenses,'planned') + sumCustom(m,'planned');
    return {incA, expA, netA:incA-expA, incP, expP, netP:incP-expP};
  }

  // --- Mortgage math ---
  function mortgagePayment(principal, annualRate, years){
    const r=annualRate/100/12;
    const n=years*12;
    if(r===0) return principal/n;
    return principal*(r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1);
  }
  function mortgageTotals(mo){
    const loan=Math.max(0, num(mo.homePrice)-num(mo.downPayment));
    const pAndI=mortgagePayment(loan, num(mo.interestRate), num(mo.termYears));
    const escrows=num(mo.propertyTaxMonthly)+num(mo.insuranceMonthly)+num(mo.hoaMonthly);
    const totalBase=pAndI+escrows;
    const extraMonthly=Math.max(0,num(mo.extraMonthly));
    const totalWithExtra=totalBase+extraMonthly;
    return {loan, pAndI, escrows, totalBase, extraMonthly, totalWithExtra};
  }

  // --- Auto loan math ---
  function autoLoanPayment(principal, annualRate, termMonths){
    const r=annualRate/100/12;
    const n=Math.max(1, Math.round(termMonths));
    if(!isFinite(n) || n<=0) return 0;
    if(r===0) return principal/n;
    return principal*(r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1);
  }
  function autoLoanTotals(ao){
    const loan=Math.max(0, num(ao.loanAmount));
    const payment=autoLoanPayment(loan, num(ao.interestRate), num(ao.termMonths));
    const extraMonthly=Math.max(0, num(ao.extraMonthly));
    const totalWithExtra=payment+extraMonthly;
    return {loan, payment, extraMonthly, totalWithExtra};
  }
  function autoLoanSchedule(ao){
    const loan0=Math.max(0, num(ao.loanAmount));
    const r=num(ao.interestRate)/100/12;
    const base=autoLoanPayment(loan0, num(ao.interestRate), num(ao.termMonths));
    const extraM=Math.max(0, num(ao.extraMonthly));
    const extraOne=Math.max(0, num(ao.extraOneTime));
    const extraOneMonth=String(ao.extraOneTimeMonth||currentMonthId);

    let bal=loan0;
    let month=0;
    const out=[];
    let curYM=String(ao.startDate||currentMonthId+"-01").slice(0,7);

    const addMonths=(ym, add)=>{
      const [y,m]=ym.split("-").map(Number);
      const d=new Date(y,m-1,1);
      d.setMonth(d.getMonth()+add);
      const yy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      return yy+"-"+mm;
    };

    while(bal>0 && month<600){
      const interest=r===0?0:bal*r;
      let principalPay=Math.max(0, base - interest);
      let extra=extraM;
      if(curYM===extraOneMonth) extra += extraOne;
      let principalTotal=principalPay+extra;
      if(principalTotal>bal) principalTotal=bal;
      const payment=interest+principalTotal;
      bal=bal-principalTotal;
      out.push({ym:curYM, payment, interest, principal:principalTotal, extra, balance:bal});
      month++;
      curYM=addMonths(curYM,1);
    }
    return out;
  }

  function amortSchedule(mo){
    const loan0=Math.max(0, num(mo.homePrice)-num(mo.downPayment));
    const r=num(mo.interestRate)/100/12;
    const basePI=mortgagePayment(loan0, num(mo.interestRate), num(mo.termYears));
    const extraM=Math.max(0,num(mo.extraMonthly));
    const extraOne=Math.max(0,num(mo.extraOneTime));
    const extraOneMonth=String(mo.extraOneTimeMonth||currentMonthId);

    let bal=loan0;
    let month=0;
    const out=[];
    let curYM=String(mo.startDate||currentMonthId+"-01").slice(0,7);

    const addMonths=(ym, add)=>{
      const [y,m]=ym.split('-').map(Number);
      const d=new Date(y,m-1,1);
      d.setMonth(d.getMonth()+add);
      const yy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,'0');
      return `${yy}-${mm}`;
    };

    while(bal>0 && month<1200){
      const interest=r===0?0:bal*r;
      let payment=Math.min(basePI+extraM, bal+interest);
      let principal=Math.max(0, payment-interest);

      // one-time extra (applies in selected month)
      if(curYM===extraOneMonth && extraOne>0){
        const extraApplied=Math.min(extraOne, bal-principal);
        principal += extraApplied;
        payment += extraApplied;
      }

      bal=Math.max(0, bal-principal);
      out.push({ym:curYM, payment, principal, interest, balance:bal});
      month++;
      curYM=addMonths(curYM,1);
    }
    return {rows:out, months:out.length, payoffYM: out.length?out[out.length-1].ym: currentMonthId, basePI};
  }

  // --- Rendering ---
  function renderTop(){
    const sel=$('#monthSel');
    sel.innerHTML='';
    const months=Object.keys(state.months).sort();
    for(const id of months){
      const opt=document.createElement('option');
      opt.value=id;
      opt.textContent=state.months[id].name || monthLabel(id);
      sel.appendChild(opt);
    }
    // ensure current exists
    ensureMonth(currentMonthId);
    if(!months.includes(currentMonthId)){
      const opt=document.createElement('option');
      opt.value=currentMonthId;
      opt.textContent=monthLabel(currentMonthId);
      sel.appendChild(opt);
    }
    sel.value=currentMonthId;

    sel.onchange=()=>setMonth(sel.value);

    $('#addMonthBtn').onclick=()=>{
      const cur=currentMonthId;
      const [y,m]=cur.split('-').map(Number);
      const d=new Date(y,m-1,1); d.setMonth(d.getMonth()+1);
      const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      ensureMonth(ym);
      state.months[ym].name=monthLabel(ym);
      save();
      toast('Added '+monthLabel(ym));
      setMonth(ym);
    };

    $('#exportBtn').onclick=()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`family-budget-buddy_${currentMonthId}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      toast('Exported backup JSON');
    };

    $('#importBtn').onclick=()=>$('#filePick').click();
    $('#filePick').onchange=async(e)=>{
      const f=e.target.files?.[0];
      if(!f) return;
      try{
        const txt=await f.text();
        const obj=JSON.parse(txt);
        if(!obj || !obj.months) throw new Error('Not a valid file');
        localStorage.setItem(KEY, JSON.stringify(obj));
        location.reload();
      }catch(err){toast('Import failed: '+err.message)}
    };

    $('#resetBtn').onclick=()=>{
      if(confirm('Reset ALL saved data on this browser?')){
        localStorage.removeItem(KEY);
        location.reload();
      }
    };
  }

  function renderTabs(){
    const t=$('#tabs');
    t.innerHTML='';
    for(const x of tabs){
      const b=document.createElement('button');
      b.className='tab'+(x.id===activeTab?' on':'');
      b.textContent=x.label;
      b.onclick=()=>{activeTab=x.id; renderTab();};
      t.appendChild(b);
    }
  }

  function renderKPIs(){
    const {incA, expA, netA}=totals();
    $('#kIncome').textContent=fmt(incA);
    $('#kExp').textContent=fmt(expA);
    const k=$('#kNet');
    k.textContent=fmt(netA);
    k.style.color = netA>=0 ? 'var(--good)' : 'var(--bad)';
  }

  function renderTab(){
    renderTabs();
    const titleMap={dash:'Dashboard',income:'Income',exp:'Expenses',auto:'Auto Loan',mort:'Mortgage',custom:'Custom',docs:'Documents'};
    $('#tabTitle').textContent=titleMap[activeTab]||'Dashboard';
    const body=$('#tabBody');
    body.innerHTML='';
    if(activeTab==='dash') body.appendChild(viewDashboard());
    if(activeTab==='income') body.appendChild(viewLedger('income'));
    if(activeTab==='exp') body.appendChild(viewLedger('expense'));
    if(activeTab==='auto') body.appendChild(viewAutoLoan());
    if(activeTab==='mort') body.appendChild(viewMortgage());
    if(activeTab==='custom') body.appendChild(viewCustom());
    if(activeTab==='docs') body.appendChild(viewDocs());
    renderKPIs();
    drawCharts();
  }

  function viewDashboard(){
    const m=current();
    const wrap=document.createElement('div');
    const {incA,expA,netA,incP,expP,netP}=totals();

    const box=document.createElement('div');
    box.className='kpis';
    box.innerHTML=`
      <div class="kpi"><div class="lab">Planned net</div><div class="val" style="color:${netP>=0?'var(--good)':'var(--bad)'}">${fmt(netP)}</div></div>
      <div class="kpi"><div class="lab">Actual net</div><div class="val" style="color:${netA>=0?'var(--good)':'var(--bad)'}">${fmt(netA)}</div></div>
      <div class="kpi"><div class="lab">Notes</div><input class="in" id="notes" placeholder="Anything important this month?" value="${escapeAttr(m.notes||'')}"/></div>
    `;
    wrap.appendChild(box);

    wrap.appendChild(line());

    const mini=document.createElement('div');
    mini.innerHTML=`
      <div class="badge"><span class="dot" style="background:var(--g)"></span><span><b>Try this:</b> Add your mortgage details under <b>Mortgage</b>, then see the payoff date and early-payoff impact.</span></div>
      <div style="height:10px"></div>
      <div class="badge"><span class="dot" style="background:var(--w)"></span><span><b>Tip:</b> Use <b>Planned</b> for your target budget and <b>Actual</b> as you spend.</span></div>
    `;
    wrap.appendChild(mini);

    // Notes binding
    setTimeout(()=>{
      const n=$('#notes');
      if(n){
        n.oninput=()=>{m.notes=n.value; save();};
      }
    },0);

    return wrap;
  }

  function line(){const hr=document.createElement('hr'); return hr;}

  function viewLedger(kind){
    const m=current();
    const isIncome=kind==='income';
    const rows=isIncome?m.incomes:m.expenses;

    const universal = isIncome ? !!state.settings.universalIncome : !!state.settings.universalExpenses;

    const wrap=document.createElement('div');

    const head=document.createElement('div');
    head.style.display='flex';head.style.gap='10px';head.style.flexWrap='wrap';head.style.alignItems='center';head.style.justifyContent='space-between';
    head.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <div class="badge"><span class="dot" style="background:${isIncome?'var(--good)':'var(--a)'}"></span><span>${isIncome?'Money coming in':'Money going out'} — add, rename, and categorize anything.</span></div>
        <label class="badge" style="cursor:pointer">
          <input type="checkbox" id="universalEdits" style="width:16px;height:16px"/>
          <span>Apply edits to all months</span>
        </label>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn good" id="addRow">+ Add row</button>
        <button class="btn ghost" id="copyPlanned">Copy Planned → Actual</button>
      </div>
    `;
    wrap.appendChild(head);
    // universal edits toggle
    const uni=head.querySelector('#universalEdits');
    if(uni){
      uni.checked = universal;
      uni.onchange = ()=>{
        if(isIncome) state.settings.universalIncome = !!uni.checked;
        else state.settings.universalExpenses = !!uni.checked;
        save();
        toast(uni.checked?'Universal edits ON':'Universal edits OFF');
        renderTab();
      };
    }
    wrap.appendChild(line());

    const tbl=document.createElement('table');
    tbl.className='table';
    tbl.innerHTML=`
      <thead>
        <tr>
          <th style="width:26%">Name</th>
          <th style="width:18%">Category</th>
          <th style="width:16%">When</th>
          <th style="width:14%">Planned</th>
          <th style="width:14%">Actual</th>
          <th style="width:12%"></th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    `;
    wrap.appendChild(tbl);

    const tb=tbl.querySelector('#tb');
    for(const r of rows){tb.appendChild(rowEditor(r, rows, isIncome, universal));}

    // Footer totals
    const foot=document.createElement('div');
    const sumP=sumRows(rows,'planned');
    const sumA=sumRows(rows,'actual');
    foot.innerHTML=`
      <div class="kpis" style="grid-template-columns:repeat(2,1fr);margin-top:10px">
        <div class="kpi"><div class="lab">${isIncome?'Total planned income':'Total planned expenses'} </div><div class="val">${fmt(sumP)}</div></div>
        <div class="kpi"><div class="lab">${isIncome?'Total actual income':'Total actual expenses'} </div><div class="val">${fmt(sumA)}</div></div>
      </div>
    `;
    wrap.appendChild(foot);

    // buttons
    wrap.querySelector('#addRow').onclick=()=>{
      const fresh={id:uid(), name:isIncome?'New income':'New expense', category:isIncome?'Other':'Other', when:'Recurring', planned:0, actual:0};
      if(universal){
        addRowAllMonths(isIncome?'income':'expense', fresh);
      }else{
        rows.push(fresh);
      }
      save(); renderTab(); toast('Row added');
    };
    wrap.querySelector('#copyPlanned').onclick=()=>{
      if(universal){
        for(const mo of Object.values(state.months)) {
          const arr = isIncome ? mo.incomes : mo.expenses;
          arr.forEach(r=>r.actual=num(r.planned));
        }
      }else{
        rows.forEach(r=>r.actual=num(r.planned));
      }
      save(); renderAll(); toast('Copied planned to actual');
    };

    return wrap;
  }

  function escapeAttr(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // HTML-safe text for innerHTML contexts
  function escapeHtml(s){
    return String(s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  // Alias used by the month summary exporter
  const money = (n)=>fmt(n);

  function downloadText(text, filename, mime){
    const blob=new Blob([text],{type:mime||'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=filename||'download.txt';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function rowEditor(r, rows, isIncome, universal){
    const tr=document.createElement('tr');
    tr.className='tr';
    tr.innerHTML=`
      <td><input class="in" value="${escapeAttr(r.name)}" /></td>
      <td><input class="in" value="${escapeAttr(r.category)}" placeholder="e.g., Bills"/></td>
      <td>
        <select class="in sel">
          <option>Recurring</option>
          <option>Flexible</option>
          <option>One-time</option>
        </select>
      </td>
      <td><input class="in" inputmode="decimal" value="${escapeAttr(r.planned)}" /></td>
      <td><input class="in" inputmode="decimal" value="${escapeAttr(r.actual)}" /></td>
      <td style="text-align:right"><button class="btn ghost" title="Remove">✕</button></td>
    `;
    const [name,cat,when,plan,act]=tr.querySelectorAll('input,select');
    when.value=r.when||'Recurring';

    name.oninput=()=>{
      r.name=name.value;
      if(universal) propagateRow(isIncome?'income':'expense', r.id, rr=>rr.name=r.name);
      save(); drawCharts();
    };
    cat.oninput=()=>{
      r.category=cat.value;
      if(universal) propagateRow(isIncome?'income':'expense', r.id, rr=>rr.category=r.category);
      save(); drawCharts();
    };
    when.onchange=()=>{
      r.when=when.value;
      if(universal) propagateRow(isIncome?'income':'expense', r.id, rr=>rr.when=r.when);
      save();
    };
    plan.oninput=()=>{
      r.planned=num(plan.value);
      if(universal) propagateRow(isIncome?'income':'expense', r.id, rr=>rr.planned=r.planned);
      save(); renderKPIs(); drawCharts();
    };
    act.oninput=()=>{
      r.actual=num(act.value);
      if(universal) propagateRow(isIncome?'income':'expense', r.id, rr=>rr.actual=r.actual);
      save(); renderKPIs(); drawCharts();
    };

    tr.querySelector('button').onclick=()=>{
      if(universal){
        removeRowAllMonths(isIncome?'income':'expense', r.id);
      }else{
        const idx=rows.findIndex(x=>x.id===r.id);
        if(idx>=0) rows.splice(idx,1);
      }
      save(); renderAll(); toast('Removed');
    };
    return tr;
  }

  function viewMortgage(){
    const m=current();
    const mo=m.mortgage;
    const wrap=document.createElement('div');

    const top=document.createElement('div');
    top.innerHTML=`
      <div class="badge"><span class="dot" style="background:var(--a)"></span>
      <span><b>Mortgage planner:</b> monthly payment, full amortization schedule, and early payoff impact.</span></div>
    `;
    wrap.appendChild(top);
    wrap.appendChild(line());

    const grid=document.createElement('div');
    grid.style.display='grid';
    grid.style.gridTemplateColumns='repeat(2,1fr)';
    grid.style.gap='10px';
    grid.innerHTML=`
      <div><div class="small">Home price</div><input class="in" id="homePrice" value="${escapeAttr(mo.homePrice)}"/></div>
      <div><div class="small">Down payment</div><input class="in" id="down" value="${escapeAttr(mo.downPayment)}"/></div>
      <div><div class="small">Interest rate (APR %)</div><input class="in" id="rate" value="${escapeAttr(mo.interestRate)}"/></div>
      <div><div class="small">Term (years)</div><input class="in" id="term" value="${escapeAttr(mo.termYears)}"/></div>
      <div><div class="small">Start month (YYYY-MM)</div><input class="in" id="start" value="${escapeAttr(String(mo.startDate||currentMonthId+"-01").slice(0,7))}"/></div>
      <div><div class="small">Property tax (monthly)</div><input class="in" id="tax" value="${escapeAttr(mo.propertyTaxMonthly)}"/></div>
      <div><div class="small">Insurance (monthly)</div><input class="in" id="ins" value="${escapeAttr(mo.insuranceMonthly)}"/></div>
      <div><div class="small">HOA (monthly)</div><input class="in" id="hoa" value="${escapeAttr(mo.hoaMonthly)}"/></div>
    `;
    wrap.appendChild(grid);

    wrap.appendChild(line());

    const payoff=document.createElement('div');
    payoff.innerHTML=`
      <div class="kpis" style="grid-template-columns:repeat(3,1fr)">
        <div class="kpi"><div class="lab">Extra payment (monthly)</div><input class="in" id="extraM" value="${escapeAttr(mo.extraMonthly)}"/></div>
        <div class="kpi"><div class="lab">One-time extra amount</div><input class="in" id="extra1" value="${escapeAttr(mo.extraOneTime)}"/></div>
        <div class="kpi"><div class="lab">One-time extra month (YYYY-MM)</div><input class="in" id="extra1m" value="${escapeAttr(mo.extraOneTimeMonth||currentMonthId)}"/></div>
      </div>
    `;
    wrap.appendChild(payoff);

    const out=document.createElement('div');
    out.style.marginTop='12px';
    out.innerHTML=`<div class="kpis" style="grid-template-columns:repeat(4,1fr)">
      <div class="kpi"><div class="lab">Loan amount</div><div class="val" id="loanAmt">$0</div></div>
      <div class="kpi"><div class="lab">Monthly P&amp;I</div><div class="val" id="pi">$0</div></div>
      <div class="kpi"><div class="lab">Escrows (tax/ins/HOA)</div><div class="val" id="esc">$0</div></div>
      <div class="kpi"><div class="lab">Total monthly outflow (incl. extra payoff)</div><div class="val" id="total">$0</div></div>
    </div>`;
    wrap.appendChild(out);

    const payoffOut=document.createElement('div');
    payoffOut.style.marginTop='10px';
    payoffOut.innerHTML=`<div class="badge"><span class="dot" style="background:var(--good)"></span><span id="payoffText">Payoff estimate…</span></div>`;
    wrap.appendChild(payoffOut);

    // 28/36 guideline (affordability)
    const guide=document.createElement('div');
    guide.style.marginTop='12px';
    guide.innerHTML=`
      <div class="badge"><span class="dot" style="background:var(--g)"></span>
        <span><b>28/36 guideline:</b> housing (PITI) ≤ 28% of gross monthly income, and total monthly debt ≤ 36%.</span>
      </div>
      <div style="margin-top:10px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
        <div>
          <div class="small">Income source</div>
          <select class="in sel" id="incBasis">
            <option value="actual">Use this month’s Actual income</option>
            <option value="planned">Use this month’s Planned income</option>
            <option value="imputed">Use Imputed income</option>
          </select>
        </div>
        <div>
          <div class="small">Imputed gross monthly income</div>
          <input class="in" id="impInc" value="${escapeAttr((mo.imputedIncomeMonthly ?? ''))}" placeholder="Auto-fills from income totals"/>
        </div>
        <div>
          <div class="small">Other monthly debt (car, credit cards, student loans…)</div>
          <input class="in" id="otherDebt" value="${escapeAttr((mo.otherDebtMonthly ?? 0))}"/>
        </div>
      </div>

      <div class="kpis" style="margin-top:10px;grid-template-columns:repeat(3,1fr)">
        <div class="kpi"><div class="lab">Gross monthly income used</div><div class="val" id="gIncome">$0</div></div>
        <div class="kpi"><div class="lab">Max housing (28%)</div><div class="val" id="gMaxHousing">$0</div></div>
        <div class="kpi"><div class="lab">Max total debt (36%)</div><div class="val" id="gMaxDebt">$0</div></div>
      </div>

      <div class="kpis" style="margin-top:10px;grid-template-columns:repeat(3,1fr)">
        <div class="kpi"><div class="lab">Your housing cost (PITI)</div><div class="val" id="gPITI">$0</div><div class="small">P&I + tax + ins + HOA (excludes extra payoff)</div></div>
        <div class="kpi"><div class="lab">Housing cost incl. extra payoff</div><div class="val" id="gPITIExtra">$0</div><div class="small">What you’d actually pay monthly</div></div>
        <div class="kpi"><div class="lab">Allowed housing after 36% rule</div><div class="val" id="gAllowedHousing">$0</div><div class="small">Min(28% income, 36% income - other debt)</div></div>
      </div>

      <div class="kpis" style="margin-top:10px;grid-template-columns:repeat(3,1fr)">
        <div class="kpi"><div class="lab">Housing ratio (PITI / income)</div><div class="val" id="gHousingRatio">0%</div></div>
        <div class="kpi"><div class="lab">Total debt ratio ((PITI + other debt) / income)</div><div class="val" id="gDebtRatio">0%</div></div>
        <div class="kpi"><div class="lab">Affordable home estimate</div>
          <div class="val" id="gRecPrice">$0</div>
          <div class="small" id="gRecNote">Based on your rate/term/down payment and the guideline payment cap.</div>
        </div>
      </div>
    `;
    wrap.appendChild(guide);

    wrap.appendChild(line());

    const btnRow=document.createElement('div');
    btnRow.style.display='flex';btnRow.style.gap='10px';btnRow.style.flexWrap='wrap';
    btnRow.innerHTML=`
      <button class="btn ghost" id="toggle">Show amortization schedule</button>
      <label class="badge" style="cursor:pointer">
        <input type="checkbox" id="autoMortExp" style="width:16px;height:16px"/>
        <span>Auto-sync mortgage into Expenses</span>
      </label>
      <button class="btn good" id="applyAsExpense">Sync now</button>
    `;
    wrap.appendChild(btnRow);

    const schedWrap=document.createElement('div');
    schedWrap.style.display='none';
    schedWrap.style.marginTop='12px';
    schedWrap.innerHTML=`
      <div class="small">First 60 rows shown (export JSON for full data). Balance will hit $0 at payoff month.</div>
      <table class="table" style="margin-top:8px">
        <thead><tr><th style="width:18%">Month</th><th>Payment</th><th>Principal</th><th>Interest</th><th>Balance</th></tr></thead>
        <tbody id="sched"></tbody>
      </table>
    `;
    wrap.appendChild(schedWrap);

    // bindings
    const bind=(id, key, transform=num)=>{
      const el=wrap.querySelector('#'+id);
      el.oninput=()=>{mo[key]=transform(el.value); save(); renderAll();};
    };
    bind('homePrice','homePrice');
    bind('down','downPayment');
    bind('rate','interestRate');
    bind('term','termYears');
    const startEl=wrap.querySelector('#start');
    startEl.oninput=()=>{mo.startDate=String(startEl.value||currentMonthId)+"-01"; save(); renderAll();};
    bind('tax','propertyTaxMonthly');
    bind('ins','insuranceMonthly');
    bind('hoa','hoaMonthly');
    bind('extraM','extraMonthly');
    bind('extra1','extraOneTime');
    const extra1m=wrap.querySelector('#extra1m');
    extra1m.oninput=()=>{mo.extraOneTimeMonth=String(extra1m.value||currentMonthId); save(); renderAll();};

    const toggle=wrap.querySelector('#toggle');
    toggle.onclick=()=>{
      schedWrap.style.display = schedWrap.style.display==='none'?'block':'none';
      toggle.textContent = schedWrap.style.display==='none'?'Show amortization schedule':'Hide amortization schedule';
    };

    const auto=wrap.querySelector('#autoMortExp');
    if(auto){
      auto.checked = !!state.settings.includeMortgageExpense;
      auto.onchange = ()=>{
        state.settings.includeMortgageExpense = !!auto.checked;
        save();
        if(state.settings.includeMortgageExpense){
          syncMortgageExpense(m);
          toast('Mortgage auto-sync ON');
        }else{
          toast('Mortgage auto-sync OFF');
        }
        renderAll();
      };
    }

    wrap.querySelector('#applyAsExpense').onclick=()=>{
      syncMortgageExpense(m);
      save(); renderAll(); toast('Synced Mortgage into Expenses');
    };

    updateMortgageOutputs(wrap);
    return wrap;
  }


  function pct(v){
    return (Math.max(0, v)*100).toFixed(1)+'%';
  }

  function solveLoanForPayment(targetPayment, rateAPR, termYears){
    // Solve for principal given a target monthly P&I payment.
    const r = (rateAPR/100)/12;
    const n = Math.max(1, Math.round(termYears*12));
    if(targetPayment<=0) return 0;
    if(r===0) return targetPayment*n;
    // payment = P * r*(1+r)^n / ((1+r)^n - 1)
    const pow = Math.pow(1+r, n);
    const denom = (r*pow)/(pow-1);
    if(denom<=0) return 0;
    return targetPayment/denom;
  }

  function guidelineInputs(mo){
    const m=current();
    const basis = mo.incomeBasis || 'actual';
    const incPlanned = totalIncome(m,'planned');
    const incActual = totalIncome(m,'actual');
    const fallback = incActual || incPlanned || 0;
    if(mo.imputedIncomeMonthly===null || mo.imputedIncomeMonthly===undefined || mo.imputedIncomeMonthly===''){
      mo.imputedIncomeMonthly = fallback;
    }
    let incomeUsed = fallback;
    if(basis==='planned') incomeUsed = incPlanned || fallback;
    if(basis==='actual') incomeUsed = incActual || fallback;
    if(basis==='imputed') incomeUsed = num(mo.imputedIncomeMonthly);

    const otherDebt = num(mo.otherDebtMonthly||0);
    return {basis, incomeUsed:Math.max(0,incomeUsed), otherDebt:Math.max(0,otherDebt)};
  }



  function viewAutoLoan(){
    const m=current();
    const ao=m.autoLoan;
    const wrap=document.createElement('div');

    const top=document.createElement('div');
    top.innerHTML=`
      <div class="badge"><span class="dot" style="background:var(--w)"></span>
      <span><b>Auto loan planner:</b> monthly payment, full amortization schedule, and early payoff impact.</span></div>
    `;
    wrap.appendChild(top);
    wrap.appendChild(line());

    const grid=document.createElement('div');
    grid.style.display='grid';
    grid.style.gridTemplateColumns='repeat(2,1fr)';
    grid.style.gap='10px';
    grid.innerHTML=`
      <div><div class="small">Loan amount</div><input class="in" id="a_loan" value="${escapeAttr(ao.loanAmount)}"/></div>
      <div><div class="small">Interest rate (APR %)</div><input class="in" id="a_rate" value="${escapeAttr(ao.interestRate)}"/></div>
      <div><div class="small">Term (months)</div><input class="in" id="a_term" value="${escapeAttr(ao.termMonths)}"/></div>
      <div><div class="small">Start month (YYYY-MM)</div><input class="in" id="a_start" value="${escapeAttr(String(ao.startDate||currentMonthId+"-01").slice(0,7))}"/></div>
    `;
    wrap.appendChild(grid);

    wrap.appendChild(line());

    const payoff=document.createElement('div');
    payoff.innerHTML=`
      <div class="kpis" style="grid-template-columns:repeat(3,1fr)">
        <div class="kpi"><div class="lab">Extra payment (monthly)</div><input class="in" id="a_extraM" value="${escapeAttr(ao.extraMonthly)}"/></div>
        <div class="kpi"><div class="lab">One-time extra amount</div><input class="in" id="a_extra1" value="${escapeAttr(ao.extraOneTime)}"/></div>
        <div class="kpi"><div class="lab">One-time extra month (YYYY-MM)</div><input class="in" id="a_extra1m" value="${escapeAttr(ao.extraOneTimeMonth||currentMonthId)}"/></div>
      </div>
    `;
    wrap.appendChild(payoff);

    const out=document.createElement('div');
    out.style.marginTop='12px';
    out.innerHTML=`
      <div class="kpis" style="grid-template-columns:repeat(3,1fr)">
        <div class="kpi"><div class="lab">Loan amount</div><div class="val" id="a_out_loan">$0</div></div>
        <div class="kpi"><div class="lab">Base monthly payment</div><div class="val" id="a_out_pay">$0</div></div>
        <div class="kpi"><div class="lab">Total monthly outflow (incl. extra payoff)</div><div class="val" id="a_out_total">$0</div></div>
      </div>
    `;
    wrap.appendChild(out);

    const payoffOut=document.createElement('div');
    payoffOut.style.marginTop='10px';
    payoffOut.innerHTML=`<div class="badge"><span class="dot" style="background:var(--good)"></span><span id="a_payoffText">Payoff estimate…</span></div>`;
    wrap.appendChild(payoffOut);

    wrap.appendChild(line());

    const controls=document.createElement('div');
    controls.style.display='flex';
    controls.style.gap='10px';
    controls.style.flexWrap='wrap';
    controls.style.alignItems='center';
    controls.style.justifyContent='space-between';
    controls.innerHTML=`
      <label class="badge" style="cursor:pointer">
        <input type="checkbox" id="a_autoSync" style="width:16px;height:16px"/>
        <span>Auto-sync Auto Loan into Expenses</span>
      </label>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn ghost" id="a_syncNow">Sync into Expenses now</button>
        <button class="btn" id="a_exportJson">Export JSON</button>
      </div>
    `;
    wrap.appendChild(controls);

    const sched=document.createElement('div');
    sched.style.marginTop='12px';
    sched.innerHTML=`
      <div class="badge"><span class="dot" style="background:var(--w)"></span><span><b>Amortization schedule</b> (shows payoff with early payments)</span></div>
      <div style="overflow:auto;margin-top:10px">
        <table class="tbl" style="min-width:760px">
          <thead><tr>
            <th style="width:12%">Month</th>
            <th style="width:18%">Payment</th>
            <th style="width:18%">Interest</th>
            <th style="width:18%">Principal</th>
            <th style="width:18%">Extra</th>
            <th style="width:16%">Balance</th>
          </tr></thead>
          <tbody id="a_schedBody"></tbody>
        </table>
      </div>
      <div class="small" id="a_schedNote" style="margin-top:8px;opacity:.9"></div>
    `;
    wrap.appendChild(sched);

    // bindings
    const q=(id)=>wrap.querySelector(id);
    q('#a_autoSync').checked = !!state.settings.includeAutoLoanExpense;
    q('#a_autoSync').onchange=()=>{
      state.settings.includeAutoLoanExpense = !!q('#a_autoSync').checked;
      if(state.settings.includeAutoLoanExpense){
        syncAutoLoanExpense(current());
        toast('Auto loan auto-sync ON');
      }else{
        toast('Auto loan auto-sync OFF');
      }
      save(); renderAll();
    };

    q('#a_syncNow').onclick=()=>{
      syncAutoLoanExpense(current());
      save(); renderAll();
      toast('Synced Auto Loan into Expenses');
    };

    q('#a_exportJson').onclick=()=>{
      exportJSON();
    };

    const bindNum=(sel, key)=>{
      q(sel).oninput=()=>{ ao[key]=num(q(sel).value); updateAutoLoanOutputs(wrap); save(); renderKPIs(); drawCharts(); };
    };
    bindNum('#a_loan','loanAmount');
    bindNum('#a_rate','interestRate');
    bindNum('#a_term','termMonths');
    bindNum('#a_extraM','extraMonthly');
    bindNum('#a_extra1','extraOneTime');

    q('#a_start').oninput=()=>{ ao.startDate=String(q('#a_start').value||'').slice(0,7)+'-01'; updateAutoLoanOutputs(wrap); save(); };
    q('#a_extra1m').oninput=()=>{ ao.extraOneTimeMonth=String(q('#a_extra1m').value||'').slice(0,7); updateAutoLoanOutputs(wrap); save(); };

    updateAutoLoanOutputs(wrap);
    return wrap;
  }

  function updateAutoLoanOutputs(scope){
    const m=current();
    const ao=m.autoLoan||{};
    const t=autoLoanTotals(ao);

    const set=(id,val)=>{ const el=scope.querySelector(id); if(el) el.textContent=val; };
    set('#a_out_loan', fmt(t.loan));
    set('#a_out_pay', fmt(t.payment));
    set('#a_out_total', fmt(t.totalWithExtra));

    // schedule
    const s=autoLoanSchedule(ao);
    const tb=scope.querySelector('#a_schedBody');
    if(tb){
      tb.innerHTML='';
      const show=s.slice(0,240);
      let totalInt=0;
      for(const row of show){
        totalInt += (row.interest||0);
        const tr=document.createElement('tr');
        tr.className='tr';
        tr.innerHTML=`
          <td>${escapeAttr(row.ym)}</td>
          <td>${fmt(row.payment)}</td>
          <td>${fmt(row.interest)}</td>
          <td>${fmt(row.principal)}</td>
          <td>${fmt(row.extra)}</td>
          <td>${fmt(row.balance)}</td>
        `;
        tb.appendChild(tr);
      }
      const note=scope.querySelector('#a_schedNote');
      if(note){
        const last=s[s.length-1];
        const payoff=last?last.ym:'—';
        const fullMonths=Math.round(num(ao.termMonths)||0);
        const savedMonths=Math.max(0, fullMonths - s.length);
        // total interest across full schedule
        const totalInterest=s.reduce((a,r)=>a+num(r.interest),0);
        note.textContent = `Payoff month: ${payoff}. Total interest (with early payments): ${fmt(totalInterest)}. Months saved vs term: ${savedMonths}.`;
        const pt=scope.querySelector('#a_payoffText');
        if(pt) pt.textContent = `Estimated payoff month: ${payoff} (saved ${savedMonths} months vs original term). Total interest: ${fmt(totalInterest)}.`;
      }
    }

    // keep expenses in sync
    try{ syncAutoLoanExpense(m); }catch(e){}
  }

  function updateMortgageGuideline(scope){
    const mo=current().mortgage;
    const mt=mortgageTotals(mo);
    const gi=guidelineInputs(mo);
    const income=gi.incomeUsed;
    const maxHousing = income*0.28;
    const maxDebt = income*0.36;
    const allowedBy36 = Math.max(0, maxDebt - gi.otherDebt);
    const allowedHousing = Math.max(0, Math.min(maxHousing, allowedBy36));

    const piti = mt.pAndI + mt.escrows; // PITI excludes extra payoff
    const pitiExtra = mt.totalWithExtra;

    const housingRatio = income>0 ? (piti/income) : 0;
    const debtRatio = income>0 ? ((piti + gi.otherDebt)/income) : 0;

    const gIncome=scope.querySelector('#gIncome');
    const gMaxHousing=scope.querySelector('#gMaxHousing');
    const gMaxDebt=scope.querySelector('#gMaxDebt');
    const gAllowedHousing=scope.querySelector('#gAllowedHousing');
    const gPITI=scope.querySelector('#gPITI');
    const gPITIExtra=scope.querySelector('#gPITIExtra');
    const gHousingRatio=scope.querySelector('#gHousingRatio');
    const gDebtRatio=scope.querySelector('#gDebtRatio');
    const gRecPrice=scope.querySelector('#gRecPrice');
    const gRecNote=scope.querySelector('#gRecNote');

    if(gIncome) gIncome.textContent=fmt(income);
    if(gMaxHousing) gMaxHousing.textContent=fmt(maxHousing);
    if(gMaxDebt) gMaxDebt.textContent=fmt(maxDebt);
    if(gAllowedHousing) gAllowedHousing.textContent=fmt(allowedHousing);
    if(gPITI) gPITI.textContent=fmt(piti);
    if(gPITIExtra) gPITIExtra.textContent=fmt(pitiExtra);
    if(gHousingRatio) gHousingRatio.textContent=pct(housingRatio);
    if(gDebtRatio) gDebtRatio.textContent=pct(debtRatio);

    // Affordable home estimate: solve for max loan where (P&I + escrows) <= allowedHousing
    // Keep escrows fixed from inputs; solve only for P&I portion.
    const escrow = mt.escrows;
    const maxPI = Math.max(0, allowedHousing - escrow);
    const maxLoan = solveLoanForPayment(maxPI, num(mo.interestRate), num(mo.termYears));
    const estHome = Math.max(0, maxLoan + num(mo.downPayment));

    if(gRecPrice) gRecPrice.textContent=fmt(estHome);

    if(gRecNote){
      const ok28 = (income>0) ? (housingRatio<=0.28+1e-9) : false;
      const ok36 = (income>0) ? (debtRatio<=0.36+1e-9) : false;
      const status = (ok28 && ok36) ? 'On guideline.' : 'Above guideline.'
      let rec = status + ' ';
      rec += `Using ${gi.basis==='imputed'?'imputed':"this month's "+gi.basis} income and $${Math.round(gi.otherDebt).toLocaleString()} other debt.`;
      if(allowedHousing<=0 && income>0){ rec += ' Your other debt uses up the 36% cap, so housing would need to be lower.'; }
      gRecNote.textContent = rec;
    }
  }

  function updateMortgageOutputs(scope){
    const mo=current().mortgage;
    const mt=mortgageTotals(mo);
    const sch=amortSchedule(mo);
    scope.querySelector('#loanAmt').textContent=fmt(mt.loan);
    scope.querySelector('#pi').textContent=fmt(mt.pAndI);
    const escEl=scope.querySelector('#esc');
    if(escEl) escEl.textContent=fmt(mt.escrows);
    scope.querySelector('#total').textContent=fmt(mt.totalWithExtra);

    // 28/36 guideline outputs
    const incBasisEl = scope.querySelector('#incBasis');
    const impEl = scope.querySelector('#impInc');
    const debtEl = scope.querySelector('#otherDebt');
    if(incBasisEl && impEl && debtEl){
      // initialize UI values
      incBasisEl.value = mo.incomeBasis || 'actual';
      if(impEl.value==='' || impEl.value===null){ impEl.value = num(mo.imputedIncomeMonthly||0); }
      debtEl.value = num(mo.otherDebtMonthly||0);

      const applyInputs = ()=>{
        mo.incomeBasis = incBasisEl.value;
        mo.imputedIncomeMonthly = num(impEl.value);
        mo.otherDebtMonthly = num(debtEl.value);
        save();
        // re-render guideline numbers only (no full renderAll to keep typing smooth)
        updateMortgageGuideline(scope);
      };
      incBasisEl.onchange = applyInputs;
      impEl.oninput = applyInputs;
      debtEl.oninput = applyInputs;
      updateMortgageGuideline(scope);
    }

    const base=amortSchedule({...mo, extraMonthly:0, extraOneTime:0}).months;
    const saved=Math.max(0, base-sch.months);
    const msg=`Payoff: <b>${monthLabel(sch.payoffYM)}</b> (${sch.months} months). Early payoff saves about <b>${saved} months</b> vs. no extra payments.`;
    scope.querySelector('#payoffText').innerHTML=msg;

    const tb=scope.querySelector('#sched');
    if(tb){
      tb.innerHTML='';
      sch.rows.slice(0,60).forEach(r=>{
        const tr=document.createElement('tr');
        tr.className='tr';
        tr.innerHTML=`<td>${r.ym}</td><td>${fmt(r.payment)}</td><td>${fmt(r.principal)}</td><td>${fmt(r.interest)}</td><td>${fmt(r.balance)}</td>`;
        tb.appendChild(tr);
      });
    }
  }

  function viewCustom(){
    const m=current();
    const wrap=document.createElement('div');

    const head=document.createElement('div');
    head.style.display='flex';head.style.gap='10px';head.style.flexWrap='wrap';head.style.alignItems='center';head.style.justifyContent='space-between';
    head.innerHTML=`
      <div class="badge"><span class="dot" style="background:var(--w)"></span><span>Create unlimited custom sections (sinking funds, debt payoff, subscriptions, goals…).</span></div>
      <button class="btn good" id="addSec">+ Add section</button>
    `;
    wrap.appendChild(head);
    wrap.appendChild(line());

    const list=document.createElement('div');
    list.style.display='grid';
    list.style.gap='12px';

    for(const sec of m.customSections){
      list.appendChild(sectionEditor(sec, m.customSections));
    }

    wrap.appendChild(list);
    wrap.querySelector('#addSec').onclick=()=>{
      m.customSections.push({id:uid(), title:'New Section', rows:[]});
      save(); renderTab(); toast('Section added');
    };
    return wrap;
  }

  function sectionEditor(sec, arr){
    const box=document.createElement('div');
    box.className='card';
    box.innerHTML=`
      <div class="pad">
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <input class="in" id="title" value="${escapeAttr(sec.title)}" style="font-weight:800"/>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn good" id="add">+ Row</button>
            <button class="btn ghost" id="del">Delete section</button>
          </div>
        </div>
        <div style="height:10px"></div>
        <table class="table">
          <thead><tr><th style="width:30%">Name</th><th style="width:16%">Planned</th><th style="width:16%">Actual</th><th style="width:30%">Note</th><th style="width:8%"></th></tr></thead>
          <tbody id="tb"></tbody>
        </table>
      </div>
    `;
    const title=box.querySelector('#title');
    title.oninput=()=>{sec.title=title.value; save();};

    const tb=box.querySelector('#tb');
    (sec.rows||[]).forEach(r=>tb.appendChild(customRowEditor(r, sec.rows)));

    box.querySelector('#add').onclick=()=>{
      sec.rows.push({id:uid(), name:'New item', planned:0, actual:0, note:''});
      save(); renderTab();
    };

    box.querySelector('#del').onclick=()=>{
      if(confirm('Delete this section?')){
        const idx=arr.findIndex(x=>x.id===sec.id);
        if(idx>=0) arr.splice(idx,1);
        save(); renderTab(); toast('Section deleted');
      }
    };

    return box;
  }

  function customRowEditor(r, rows){
    const tr=document.createElement('tr');
    tr.className='tr';
    tr.innerHTML=`
      <td><input class="in" value="${escapeAttr(r.name)}"/></td>
      <td><input class="in" value="${escapeAttr(r.planned)}"/></td>
      <td><input class="in" value="${escapeAttr(r.actual)}"/></td>
      <td><input class="in" value="${escapeAttr(r.note)}" placeholder="optional"/></td>
      <td style="text-align:right"><button class="btn ghost">✕</button></td>
    `;
    const [n,p,a,no]=tr.querySelectorAll('input');
    n.oninput=()=>{r.name=n.value; save();};
    p.oninput=()=>{r.planned=num(p.value); save();};
    a.oninput=()=>{r.actual=num(a.value); save();};
    no.oninput=()=>{r.note=no.value; save();};
    tr.querySelector('button').onclick=()=>{
      const i=rows.findIndex(x=>x.id===r.id);
      if(i>=0) rows.splice(i,1);
      save(); renderTab();
    };
    return tr;
  }



  // --- Documents / Receipts (saved inside this HTML via localStorage) ---
  // Note: localStorage has size limits. For lots of large photos/PDFs, use Export to back up regularly.
  function fmtBytes(n){
    n = Number(n)||0;
    const u=['B','KB','MB','GB'];
    let i=0;
    while(n>=1024 && i<u.length-1){ n/=1024; i++; }
    return (i==0?String(Math.round(n)):n.toFixed(1))+' '+u[i];
  }

  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onload=()=>resolve(String(fr.result||''));
      fr.onerror=()=>reject(fr.error);
      fr.readAsDataURL(file);
    });
  }

  function viewDocs(){
    const m=current();
    if(!Array.isArray(m.documents)) m.documents=[];
    const wrap=document.createElement('div');

    const top=document.createElement('div');
    top.style.display='flex'; top.style.gap='10px'; top.style.flexWrap='wrap';
    top.style.alignItems='center'; top.style.justifyContent='space-between';

    const badge=document.createElement('div');
    badge.className='badge';
    badge.innerHTML="<span class='dot' style='background:var(--b)'></span><span>Upload receipts & invoices for <b>"+escapeHtml(m.name)+"</b>. They stay with this month. Use <b>Consolidate Month</b> to export a backup package.</span>";

    const actions=document.createElement('div');
    actions.style.display='flex'; actions.style.gap='10px'; actions.style.flexWrap='wrap';

    const upLabel=document.createElement('label');
    upLabel.className='btn good';
    upLabel.style.cursor='pointer';
    upLabel.textContent='Upload files';
    const up=document.createElement('input');
    up.type='file'; up.multiple=true; up.accept='image/*,application/pdf,.pdf';
    up.style.display='none';
    upLabel.appendChild(up);

    const camLabel=document.createElement('label');
    camLabel.className='btn good';
    camLabel.style.cursor='pointer';
    camLabel.textContent='Take photo';
    const cam=document.createElement('input');
    cam.type='file'; cam.accept='image/*'; cam.setAttribute('capture','environment');
    cam.style.display='none';
    camLabel.appendChild(cam);

    const cons=document.createElement('button');
    cons.className='btn'; cons.textContent='Consolidate Month';

    actions.appendChild(upLabel);
    actions.appendChild(camLabel);
    actions.appendChild(cons);

    top.appendChild(badge);
    top.appendChild(actions);
    wrap.appendChild(top);
    wrap.appendChild(line());

    // Link + note controls
    const ctl=document.createElement('div');
    ctl.className='card';
    ctl.innerHTML="<div class='pad'>"+
      "<div style='display:flex;gap:12px;flex-wrap:wrap;align-items:end'>"+
      "<div style='min-width:240px;flex:1'><div class='small'>Link new uploads to expense (optional)</div><select class='in' id='docLink'><option value=''>Don't link</option></select></div>"+
      "<div style='min-width:240px;flex:1'><div class='small'>Default note for new uploads (optional)</div><input class='in' id='docNote' placeholder='e.g., Gas receipt, invoice #123'/></div>"+
      "</div></div>";
    wrap.appendChild(ctl);
    wrap.appendChild(line());

    const exp=m.expenses||[];
    const sel=ctl.querySelector('#docLink');
    exp.forEach(r=>{
      const opt=document.createElement('option');
      opt.value=r.id;
      opt.textContent=(r.name||'Expense') + (r.category?(' — '+r.category):'');
      sel.appendChild(opt);
    });

    // List
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML="<div class='pad'>"+
      "<div style='display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px'>"+
      "<div><div style='font-weight:900;font-size:18px'>Documents for this month</div><div class='small'>"+escapeHtml(m.id)+"</div></div>"+
      "<div class='small'>Files are stored in your browser. Export regularly for backup.</div>"+
      "</div>"+
      "<div style='height:10px'></div>"+
      "<table class='table'><thead><tr><th style='width:30%'>File</th><th style='width:18%'>Linked expense</th><th style='width:20%'>Added</th><th style='width:22%'>Note</th><th style='width:10%'></th></tr></thead><tbody id='docRows'></tbody></table>"+
      "</div>";
    wrap.appendChild(card);

    const tb=card.querySelector('#docRows');

    const render=()=>{
      tb.innerHTML='';
      const rows=[...(m.documents||[])].sort((a,b)=>(b.addedAt||0)-(a.addedAt||0));
      if(rows.length==0){
        const tr=document.createElement('tr');
        tr.innerHTML="<td colspan='5' class='small'>No documents yet. Use Upload or Take photo above.</td>";
        tb.appendChild(tr);
        return;
      }
      rows.forEach(d=>{
        const tr=document.createElement('tr');
        tr.className='tr';
        const expName=(exp.find(r=>r.id===d.expenseId)||{}).name||'';
        const dt=new Date(d.addedAt||Date.now()).toLocaleString();
        tr.innerHTML="<td><div style='font-weight:800'>"+escapeHtml(d.name||'document')+"</div><div class='small'>"+escapeHtml(d.type||'')+" • "+fmtBytes(d.size||0)+"</div></td>"+
          "<td><select class='in' data-k='exp'><option value=''>—</option></select></td>"+
          "<td><div class='small'>"+escapeHtml(dt)+"</div></td>"+
          "<td><input class='in' data-k='note' value='"+escapeAttr(d.note||'')+"' placeholder='optional'/></td>"+
          "<td style='text-align:right;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap'>"+
            "<button class='btn' data-act='open'>Open</button><button class='btn ghost' data-act='del'>Delete</button>"+
          "</td>";
        const selExp=tr.querySelector("select[data-k='exp']");
        exp.forEach(r=>{
          const o=document.createElement('option');
          o.value=r.id; o.textContent=r.name||'Expense';
          selExp.appendChild(o);
        });
        selExp.value=d.expenseId||'';
        selExp.onchange=()=>{d.expenseId=selExp.value; save();};
        tr.querySelector("input[data-k='note']").oninput=(e)=>{d.note=e.target.value; save();};

        tr.querySelector("button[data-act='open']").onclick=()=>{
          if(!d.dataUrl){ toast('Missing file data (may have been cleared).'); return; }
          const w=window.open();
          if(!w){ toast('Popup blocked. Allow popups to view.'); return; }
          // For images/pdf we can open via embed
          w.document.write("<title>"+escapeHtml(d.name||'document')+"</title>");
          if((d.type||'').startsWith('image/')){
            w.document.write("<img src='"+d.dataUrl+"' style='max-width:100%;height:auto' />");
          }else if((d.type||'')==='application/pdf' || (d.name||'').toLowerCase().endsWith('.pdf')){
            w.document.write("<embed src='"+d.dataUrl+"' type='application/pdf' width='100%' height='100%' />");
          }else{
            w.document.write("<a download='"+escapeAttr(d.name||'file')+"' href='"+d.dataUrl+"'>Download file</a>");
          }
        };
        tr.querySelector("button[data-act='del']").onclick=()=>{
          if(confirm('Delete this document?')){
            const i=m.documents.findIndex(x=>x.id===d.id);
            if(i>=0) m.documents.splice(i,1);
            save(); render(); toast('Deleted');
          }
        };
        tb.appendChild(tr);
      });
    };
    render();

    function list(fl){
      return Array.from(fl||[]);
    }

    async function ingest(files){
      const note=ctl.querySelector('#docNote').value||'';
      const link=sel.value||'';
      for(const f of files){
        const dataUrl=await fileToDataUrl(f);
        m.documents.push({id:uid(), name:f.name||('photo_'+Date.now()+'.jpg'), type:f.type||'', size:f.size||0, addedAt:Date.now(), note:note, expenseId:link, dataUrl:dataUrl});
      }
      ctl.querySelector('#docNote').value='';
      save(); render(); toast('Added '+files.length+' file(s)');
    }

    up.onchange=(e)=>{ const files=Array.from(e.target.files||[]); if(files.length) ingest(files); up.value=''; };
    cam.onchange=(e)=>{ const files=Array.from(e.target.files||[]); if(files.length) ingest(files); cam.value=''; };

    cons.onclick=async()=>{
      // Build a month package (JSON + HTML report) and download it
      const t=totals();
      const pkg={
        month:{id:m.id, name:m.name},
        totals:t,
        incomes:m.incomes,
        expenses:m.expenses,
        customSections:m.customSections,
        mortgage:m.mortgage,
        autoLoan:m.autoLoan,
        documents:(m.documents||[]).map(d=>({id:d.id,name:d.name,type:d.type,size:d.size,addedAt:d.addedAt,note:d.note,expenseId:d.expenseId,dataUrl:d.dataUrl}))
      };
      downloadText(JSON.stringify(pkg,null,2), `budget_${m.id}_package.json`, 'application/json');
      // Simple HTML summary report
      const html = buildMonthReportHTML(m, t);
      downloadText(html, `budget_${m.id}_summary.html`, 'text/html');
      // In-depth printable report (user can Save as PDF)
      try{ downloadPDFReport(m, t); }catch(e){ console.error(e); toast('PDF report could not be generated. See console.'); }
      toast('Consolidated month exported (JSON + HTML). PDF report opened for saving.');
    };

    return wrap;
  }

  function buildMonthReportHTML(m, t){
    const esc=escapeHtml;
    const rows=(m.expenses||[]).map(r=>`<tr><td>${esc(r.name||'')}</td><td>${esc(r.category||'')}</td><td style='text-align:right'>${money(r.actual)}</td></tr>`).join('');
    const docs=(m.documents||[]).map(d=>`<li>${esc(d.name||'')} (${esc(d.type||'')}, ${fmtBytes(d.size||0)})</li>`).join('') || '<li>None</li>';
    return `<!doctype html><html><head><meta charset='utf-8'><title>Budget Summary ${esc(m.id)}</title></head><body style='font-family:system-ui'>
      <h1>Budget Summary — ${esc(m.name)} (${esc(m.id)})</h1>
      <h2>Totals</h2>
      <ul>
        <li>Income (Actual): ${money(t.incA)}</li>
        <li>Outflow (Actual): ${money(t.expA)}</li>
        <li>Net (Actual): ${money(t.netA)}</li>
      </ul>
      <h2>Expenses (Actual)</h2>
      <table border='1' cellpadding='6' cellspacing='0'><thead><tr><th>Name</th><th>Category</th><th>Actual</th></tr></thead><tbody>${rows}</tbody></table>
      <h2>Documents</h2>
      <ul>${docs}</ul>
      <p style='color:#555'>Note: Document binaries are embedded in the JSON package as data URLs (can be large).</p>
    </body></html>`;
  }

  // Open an in-depth printable report in a new tab/window and trigger the print dialog.
  // Users can choose "Save as PDF" to generate a PDF file.
  function downloadPDFReport(m, t){
    // Ensure charts are current before capturing them.
    try{ if(typeof drawCharts==='function') drawCharts(); }catch(e){ /* ignore */ }

    const pie=document.getElementById('pie');
    const bars=document.getElementById('bars');
    const pieImg=(pie && pie.toDataURL)? pie.toDataURL('image/png') : '';
    const barImg=(bars && bars.toDataURL)? bars.toDataURL('image/png') : '';

    const html = buildMonthPDFHTML(m, t, pieImg, barImg);
    const w = window.open('', '_blank');
    if(!w){ toast('Popup blocked. Allow popups to generate the PDF report.'); return; }
    w.document.open();
    w.document.write(html);
    w.document.close();
    // Give the browser a moment to lay out images before printing.
    setTimeout(()=>{ try{ w.focus(); w.print(); }catch(e){ console.error(e); } }, 650);
  }

  function buildMonthPDFHTML(m, t, pieImg, barImg){
    const esc=escapeHtml;
    const exp=(m.expenses||[]);
    const inc=(m.incomes||[]);
    const catMap={};
    exp.forEach(r=>{ const k=(r.category||'Uncategorized'); const v=+r.actual||0; catMap[k]=(catMap[k]||0)+v; });
    const topCats=Object.entries(catMap).sort((a,b)=>b[1]-a[1]).slice(0,5);

    // Basic recommendations
    const rec=[];
    if((t.netA||0) < 0){
      rec.push(`You're spending about <b>${money(Math.abs(t.netA))}</b> more than you bring in this month. Look at your top categories below and target one change that saves at least <b>${money(Math.abs(t.netA))}</b>.`);
    }else{
      rec.push(`Nice — you have a positive net cashflow of <b>${money(t.netA)}</b>. Consider assigning it to savings goals or extra principal payments.`);
    }
    if(topCats.length){
      rec.push(`Your biggest spending category is <b>${esc(topCats[0][0])}</b> at about <b>${money(topCats[0][1])}</b>. If you reduce it by 10%, you'd free up about <b>${money(topCats[0][1]*0.10)}</b>.`);
    }
    // Mortgage guideline info if present
    try{
      if(m.mortgage){
        const piti = (+m.mortgage.piti||0);
        const gi = guidelineInputs(m);
        const housingPct = gi.income>0 ? (piti/gi.income)*100 : 0;
        if(gi.income>0){
          if(housingPct>28){
            rec.push(`Housing (PITI) is about <b>${housingPct.toFixed(1)}%</b> of gross monthly income, which is above the 28% guideline. Consider a smaller payment, larger down payment, or a longer timeline.`);
          }else{
            rec.push(`Housing (PITI) is about <b>${housingPct.toFixed(1)}%</b> of gross monthly income, within the 28% guideline.`);
          }
        }
      }
    }catch(e){ /* ignore */ }

    const expenseRows = exp
      .slice()
      .sort((a,b)=>(+b.actual||0) - (+a.actual||0))
      .map(r=>`<tr><td>${esc(r.category||'')}</td><td>${esc(r.name||'')}</td><td class='num'>${money(r.planned)}</td><td class='num'>${money(r.actual)}</td><td class='num'>${money((+r.actual||0)-(+r.planned||0))}</td></tr>`)
      .join('') || `<tr><td colspan='5' class='small'>No expense rows.</td></tr>`;

    const incomeRows = inc
      .slice()
      .sort((a,b)=>(+b.actual||0) - (+a.actual||0))
      .map(r=>`<tr><td>${esc(r.name||'')}</td><td class='num'>${money(r.planned)}</td><td class='num'>${money(r.actual)}</td><td class='num'>${money((+r.actual||0)-(+r.planned||0))}</td></tr>`)
      .join('') || `<tr><td colspan='4' class='small'>No income rows.</td></tr>`;

    const topCatRows = topCats.map(([k,v])=>`<li><b>${esc(k)}</b>: ${money(v)}</li>`).join('') || '<li>None</li>';
    const docsList=(m.documents||[]).map(d=>`<li>${esc(d.name||'')} <span class='muted'>(${esc(d.type||'')}, ${fmtBytes(d.size||0)})</span> ${d.expenseId?`<span class='muted'>• linked</span>`:''}</li>`).join('') || '<li>None</li>';

    return `<!doctype html><html><head><meta charset='utf-8'>
      <title>Monthly Budget Report — ${esc(m.name)} (${esc(m.id)})</title>
      <style>
        :root{--fg:#111;--muted:#666;--line:#ddd;}
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);margin:24px;}
        h1{margin:0 0 6px 0;font-size:24px}
        h2{margin:18px 0 10px 0;font-size:16px}
        .muted{color:var(--muted)}
        .kpis{display:flex;gap:12px;flex-wrap:wrap}
        .kpi{border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-width:200px}
        .kpi .lbl{font-size:12px;color:var(--muted)}
        .kpi .val{font-size:18px;font-weight:900;margin-top:2px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid var(--line);padding:8px;vertical-align:top}
        th{background:#f6f6f6;text-align:left}
        .num{text-align:right;white-space:nowrap}
        .grid{display:grid;grid-template-columns:1fr;gap:14px}
        .card{border:1px solid var(--line);border-radius:14px;padding:12px}
        img.chart{max-width:100%;height:auto;border:1px solid var(--line);border-radius:12px}
        @media print{
          body{margin:12mm}
          .no-print{display:none}
        }
      </style>
    </head><body>
      <div class='no-print muted' style='margin-bottom:10px'>Tip: In the print dialog, choose <b>Save as PDF</b> to create a PDF file.</div>
      <h1>Monthly Budget Report — ${esc(m.name)} <span class='muted'>(${esc(m.id)})</span></h1>
      <div class='muted'>Generated ${esc(new Date().toLocaleString())}</div>

      <h2>Cashflow snapshot</h2>
      <div class='kpis'>
        <div class='kpi'><div class='lbl'>Income (Actual)</div><div class='val'>${money(t.incA)}</div></div>
        <div class='kpi'><div class='lbl'>Outflow (Actual)</div><div class='val'>${money(t.expA)}</div></div>
        <div class='kpi'><div class='lbl'>Net Cashflow (Actual)</div><div class='val'>${money(t.netA)}</div></div>
        <div class='kpi'><div class='lbl'>Savings Rate</div><div class='val'>${(t.incA>0?((t.netA/t.incA)*100).toFixed(1):'0.0')}%</div></div>
      </div>

      <h2>Charts</h2>
      <div class='grid'>
        ${pieImg?`<div class='card'><div style='font-weight:900;margin-bottom:8px'>Spending by category</div><img class='chart' src='${pieImg}' alt='Category chart'></div>`:''}
        ${barImg?`<div class='card'><div style='font-weight:900;margin-bottom:8px'>Planned vs actual</div><img class='chart' src='${barImg}' alt='Planned vs actual chart'></div>`:''}
        ${(!pieImg && !barImg)?`<div class='card muted'>Charts unavailable (could not capture). Your browser may block canvas export in some cases.</div>`:''}
      </div>

      <h2>Recommendations</h2>
      <div class='card'><ul style='margin:0;padding-left:18px'>${rec.map(x=>`<li>${x}</li>`).join('')}</ul></div>

      <h2>Top spending categories</h2>
      <div class='card'><ul style='margin:0;padding-left:18px'>${topCatRows}</ul></div>

      <h2>Income detail</h2>
      <table><thead><tr><th>Income source</th><th class='num'>Planned</th><th class='num'>Actual</th><th class='num'>Variance</th></tr></thead><tbody>${incomeRows}</tbody></table>

      <h2>Expense detail</h2>
      <table><thead><tr><th>Category</th><th>Expense</th><th class='num'>Planned</th><th class='num'>Actual</th><th class='num'>Variance</th></tr></thead><tbody>${expenseRows}</tbody></table>

      <h2>Documents</h2>
      <div class='card'><ul style='margin:0;padding-left:18px'>${docsList}</ul>
        <div class='muted' style='margin-top:8px;font-size:12px'>Note: The JSON package exported from Consolidate includes the file data for long-term storage.</div>
      </div>
    </body></html>`;
  }

  // Build a detailed report in a new window and open the print dialog.
  // Browsers can "Save as PDF" from the print dialog (works on desktop + mobile).
  function downloadPDFReport(m, t){
    const esc=escapeHtml;
    // Grab chart snapshots from the dashboard canvases (if present)
    const pie=document.getElementById('pie');
    const bars=document.getElementById('bars');
    const pieImg = pie && pie.toDataURL ? pie.toDataURL('image/png') : '';
    const barsImg = bars && bars.toDataURL ? bars.toDataURL('image/png') : '';

    // Basic insights
    const expRows=(m.expenses||[]).map(r=>({
      name:(r.name||''),
      cat:(r.category||''),
      actual:+(r.actual||0)
    })).filter(x=>x.actual>0);
    const byCat={};
    expRows.forEach(r=>{ byCat[r.cat||'Uncategorized']=(byCat[r.cat||'Uncategorized']||0)+r.actual; });
    const topCats=Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const topLines=[...expRows].sort((a,b)=>b.actual-a.actual).slice(0,5);

    // Recommendations
    const rec=[];
    if(t.netA < 0){
      rec.push(`Your month ended negative by <b>${money(Math.abs(t.netA))}</b>. Consider reducing discretionary categories or increasing income by at least this amount next month.`);
    }else{
      rec.push(`You finished positive by <b>${money(t.netA)}</b>. Consider directing a portion to savings, debt paydown, or an emergency fund.`);
    }
    if(topCats.length){
      const big=topCats[0];
      rec.push(`Your largest spending category was <b>${esc(big[0])}</b> at <b>${money(big[1])}</b>. If you reduce it by 10%, you save about <b>${money(big[1]*0.10)}</b> per month.`);
    }
    const mort = m.mortgage||{};
    if(mort && mort.loanAmount){
      // Rough housing ratio: use base payment + insurance/tax if present in the mortgage model
      const piti = (+mort.monthlyPayment||0) + (+mort.escrow||0);
      const inc = (t.incA||0);
      if(inc>0){
        const ratio = (piti/inc)*100;
        if(ratio>28) rec.push(`Housing (PITI) is about <b>${ratio.toFixed(1)}%</b> of income, above the 28% guideline. Consider lowering housing costs or increasing income.`);
        else rec.push(`Housing (PITI) is about <b>${ratio.toFixed(1)}%</b> of income, within the 28% guideline.`);
      }
    }
    const auto = m.autoLoan||{};
    if(auto && auto.loanAmount){
      const extra=+(auto.extraMonthly||0);
      if(extra>0) rec.push(`Your auto loan extra payment is <b>${money(extra)}</b>/mo. Keep it if cashflow allows; it can shorten payoff and reduce interest.`);
    }

    const html = `<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <title>Budget Report ${esc(m.id)}</title>
  <style>
    :root{ --fg:#111; --muted:#555; --line:#e6e6e6; }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--fg); margin:28px; }
    h1{ margin:0 0 6px; }
    .muted{ color:var(--muted); }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .card{ border:1px solid var(--line); border-radius:12px; padding:14px; }
    .kpis{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .kpi{ border:1px solid var(--line); border-radius:12px; padding:10px; }
    .kpi .v{ font-size:18px; font-weight:900; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; vertical-align:top; }
    th{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.04em; }
    .right{ text-align:right; }
    .pill{ display:inline-block; padding:3px 10px; border:1px solid var(--line); border-radius:999px; font-size:12px; }
    .small{ font-size:12px; }
    .rec li{ margin:8px 0; }
    .img{ width:100%; height:auto; border:1px solid var(--line); border-radius:12px; }
    @media print{ body{ margin:14mm; } .noprint{ display:none; } }
  </style>
</head>
<body>
  <div class='noprint' style='margin-bottom:12px'>
    <span class='pill'>Tip: choose <b>Save as PDF</b> in the print dialog</span>
  </div>
  <h1>Monthly Budget Report</h1>
  <div class='muted'>${esc(m.name)} &middot; ${esc(m.id)} &middot; Generated ${esc(new Date().toLocaleString())}</div>

  <div style='height:14px'></div>
  <div class='kpis'>
    <div class='kpi'><div class='muted small'>Income (Actual)</div><div class='v'>${money(t.incA)}</div></div>
    <div class='kpi'><div class='muted small'>Outflow (Actual)</div><div class='v'>${money(t.expA)}</div></div>
    <div class='kpi'><div class='muted small'>Net (Actual)</div><div class='v'>${money(t.netA)}</div></div>
  </div>

  <div style='height:16px'></div>
  <div class='grid'>
    <div class='card'>
      <div style='font-weight:900;margin-bottom:8px'>Top Categories</div>
      <table>
        <thead><tr><th>Category</th><th class='right'>Actual</th></tr></thead>
        <tbody>
          ${topCats.map(([k,v])=>`<tr><td>${esc(k)}</td><td class='right'>${money(v)}</td></tr>`).join('') || `<tr><td colspan='2' class='muted'>No spending recorded.</td></tr>`}
        </tbody>
      </table>
    </div>
    <div class='card'>
      <div style='font-weight:900;margin-bottom:8px'>Largest Expense Lines</div>
      <table>
        <thead><tr><th>Expense</th><th>Category</th><th class='right'>Actual</th></tr></thead>
        <tbody>
          ${topLines.map(r=>`<tr><td>${esc(r.name)}</td><td>${esc(r.cat)}</td><td class='right'>${money(r.actual)}</td></tr>`).join('') || `<tr><td colspan='3' class='muted'>No spending recorded.</td></tr>`}
        </tbody>
      </table>
    </div>
  </div>

  <div style='height:16px'></div>
  <div class='card'>
    <div style='font-weight:900;margin-bottom:8px'>Recommendations</div>
    <ul class='rec'>${rec.map(x=>`<li>${x}</li>`).join('')}</ul>
    <div class='small muted'>Recommendations are heuristic and based on the data entered for this month.</div>
  </div>

  <div style='height:16px'></div>
  <div class='grid'>
    <div class='card'>
      <div style='font-weight:900;margin-bottom:8px'>Spending Breakdown (chart)</div>
      ${pieImg?`<img class='img' src='${pieImg}'/>`:`<div class='muted small'>Chart not available.</div>`}
    </div>
    <div class='card'>
      <div style='font-weight:900;margin-bottom:8px'>Planned vs Actual (chart)</div>
      ${barsImg?`<img class='img' src='${barsImg}'/>`:`<div class='muted small'>Chart not available.</div>`}
    </div>
  </div>

  <div style='height:16px'></div>
  <div class='card'>
    <div style='font-weight:900;margin-bottom:8px'>All Expenses (Actual)</div>
    <table>
      <thead><tr><th>Name</th><th>Category</th><th class='right'>Actual</th></tr></thead>
      <tbody>
        ${(m.expenses||[]).map(r=>`<tr><td>${esc(r.name||'')}</td><td>${esc(r.category||'')}</td><td class='right'>${money(r.actual)}</td></tr>`).join('') || `<tr><td colspan='3' class='muted'>No expenses recorded.</td></tr>`}
      </tbody>
    </table>
  </div>

  <div style='height:16px'></div>
  <div class='card'>
    <div style='font-weight:900;margin-bottom:8px'>Documents (Receipts / Invoices)</div>
    <ul>
      ${(m.documents||[]).map(d=>{
        const dt=new Date(d.addedAt||Date.now()).toLocaleDateString();
        return `<li>${esc(d.name||'document')} <span class='muted small'>(${esc(dt)}${d.note?(' — '+esc(d.note)):''})</span></li>`;
      }).join('') || `<li class='muted'>None</li>`}
    </ul>
  </div>

  <script>
    // Auto-open print dialog shortly after render
    setTimeout(()=>{ try{ window.focus(); window.print(); }catch(e){} }, 500);
  </script>
</body>
</html>`;

    const w=window.open('','_blank');
    if(!w){ toast('Popup blocked. Allow popups to generate the PDF report.'); return; }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }
  // --- Charts (simple canvas, no dependencies) ---
  function drawCharts(){
    drawPie();
    drawBars();
  }

  function drawPie(){
    const c=$('#pie');
    const ctx=c.getContext('2d');
    const m=current();
    const groups=new Map();
    const add=(cat,val)=>{groups.set(cat,(groups.get(cat)||0)+val)};
    m.expenses.forEach(r=>add(r.category||'Other', Math.max(0,num(r.actual)||0)));
    (m.customSections||[]).forEach(sec=>{
      let v=0; (sec.rows||[]).forEach(rr=>v+=Math.max(0,num(rr.actual)||0));
      if(v>0) add(sec.title||'Custom', v);
    });
    const data=[...groups.entries()].filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]).slice(0,8);
    const total=data.reduce((a,[,v])=>a+v,0) || 1;

    const w=c.width, h=c.height;
    ctx.clearRect(0,0,w,h);
    // background
    ctx.fillStyle='rgba(5,8,18,.18)';
    ctx.fillRect(0,0,w,h);

    const cx=w*0.33, cy=h*0.52, R=Math.min(w,h)*0.32;
    let ang=-Math.PI/2;

    // palette
    const pal=['#7c5cff','#22c55e','#f59e0b','#38bdf8','#f472b6','#a3e635','#fb7185','#c084fc'];

    data.forEach(([k,v],i)=>{
      const a=v/total* Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.fillStyle=pal[i%pal.length];
      ctx.arc(cx,cy,R,ang,ang+a);
      ctx.closePath();
      ctx.fill();
      ang+=a;
    });

    // donut hole
    ctx.beginPath();
    ctx.fillStyle='rgba(11,16,32,.95)';
    ctx.arc(cx,cy,R*0.58,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle='rgba(238,242,255,.95)';
    ctx.font='900 22px ui-sans-serif, system-ui';
    ctx.textAlign='center';
    ctx.fillText('Expenses', cx, cy-6);
    ctx.font='700 16px ui-sans-serif, system-ui';
    ctx.fillStyle='rgba(183,193,255,.95)';
    ctx.fillText(fmt(total), cx, cy+18);

    // legend
    const lx=w*0.6, ly=h*0.22;
    ctx.textAlign='left';
    ctx.font='700 14px ui-sans-serif, system-ui';
    data.forEach(([k,v],i)=>{
      const y=ly+i*30;
      ctx.fillStyle=pal[i%pal.length];
      ctx.fillRect(lx,y-10,16,16);
      ctx.fillStyle='rgba(238,242,255,.95)';
      ctx.fillText(k, lx+26, y+3);
      ctx.fillStyle='rgba(183,193,255,.95)';
      ctx.fillText(fmt(v), lx+220, y+3);
    });

    // note
    if(data.length===0){
      ctx.fillStyle='rgba(183,193,255,.95)';
      ctx.font='700 16px ui-sans-serif, system-ui';
      ctx.textAlign='center';
      ctx.fillText('Add expenses to see the breakdown here.', w/2, h/2);
    }
  }

  function drawBars(){
    const c=$('#bars');
    const ctx=c.getContext('2d');
    const ids=Object.keys(state.months).sort();
    const last=ids.slice(-12);
    const vals=last.map(id=>{
      const m=state.months[id];
      const inc=sumRows(m.incomes,'actual');
      const exp=sumRows(m.expenses,'actual');
      return {id, net:inc-exp};
    });

    const w=c.width, h=c.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='rgba(5,8,18,.18)';
    ctx.fillRect(0,0,w,h);

    if(vals.length===0){
      ctx.fillStyle='rgba(183,193,255,.95)';
      ctx.font='700 16px ui-sans-serif, system-ui';
      ctx.textAlign='center';
      ctx.fillText('Add months to see your 12-month trend.', w/2, h/2);
      return;
    }

    const max=Math.max(...vals.map(v=>Math.abs(v.net)), 1);
    const pad=70;
    const base=h*0.62;
    // axis
    ctx.strokeStyle='rgba(255,255,255,.15)';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(pad, base);
    ctx.lineTo(w-pad, base);
    ctx.stroke();

    const bw=(w-2*pad)/vals.length*0.62;
    vals.forEach((v,i)=>{
      const x=pad+i*((w-2*pad)/vals.length) + ((w-2*pad)/vals.length-bw)/2;
      const hh=(Math.abs(v.net)/max)*(h*0.36);
      const y=v.net>=0? base-hh : base;
      const color=v.net>=0?'#22c55e':'#ef4444';
      ctx.fillStyle=color;
      roundRect(ctx,x,y,bw,hh,10,true,false);

      // labels
      ctx.fillStyle='rgba(183,193,255,.95)';
      ctx.font='700 11px ui-sans-serif, system-ui';
      ctx.textAlign='center';
      ctx.fillText(v.id.slice(2), x+bw/2, h-pad*0.35);
    });

    ctx.fillStyle='rgba(238,242,255,.95)';
    ctx.font='900 18px ui-sans-serif, system-ui';
    ctx.textAlign='left';
    ctx.fillText('Net cashflow (Actual)', pad, 42);
    ctx.fillStyle='rgba(183,193,255,.95)';
    ctx.font='700 13px ui-sans-serif, system-ui';
    ctx.fillText('Green = positive, Red = negative', pad, 64);
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    if(w<0){x+=w;w=-w}
    if(h<0){y+=h;h=-h}
    r=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    if(fill) ctx.fill();
    if(stroke) ctx.stroke();
  }

  function renderAll(){
    // keep mortgage reflected as a monthly expense when enabled
    try{ syncMortgageExpense(current()); }catch(e){}
    renderTop();
    renderTab();
    // update mortgage outputs if tab open
    if(activeTab==='mort'){
      const body=$('#tabBody');
      const scope=body.querySelector('div');
      if(scope) updateMortgageOutputs(body);
    }
  }

  renderAll();
})();
</script>
</body>
</html>
