<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Print Price Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#0c162b;
      --card:#0f2346;
      --text:#e9eefb;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.12);
      --accent:#67d4ff;
      --accent2:#8bffcc;
      --danger:#ff6b6b;
      --ok:#47d18c;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 10% -10%, rgba(103,212,255,.18), transparent 55%),
        radial-gradient(900px 600px at 110% 10%, rgba(139,255,204,.10), transparent 55%),
        radial-gradient(800px 500px at 45% 110%, rgba(103,212,255,.08), transparent 60%),
        var(--bg) !important;
    }

    /* --- Tailwind utility overrides (theme swap) --- */
    .bg-slate-50{ background: transparent !important; }
    .bg-slate-50\/60{ background: rgba(255,255,255,.04) !important; }
    .bg-slate-100{ background: rgba(255,255,255,.06) !important; }
    .bg-gray-100{ background: rgba(255,255,255,.06) !important; }
    .bg-white{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)) !important;
      border: 1px solid var(--line) !important;
    }

    .text-slate-400, .text-slate-500, .text-slate-600, .text-slate-700{ color: var(--muted) !important; }
    .text-slate-800, .text-slate-900{ color: var(--text) !important; }

    .border-slate-100, .border-slate-200, .border-slate-300, .border-gray-100, .border{ border-color: var(--line) !important; }
    .border-dashed{ border-style: dashed !important; }

    .shadow-sm{ box-shadow: var(--shadow) !important; }
    .rounded-2xl{ border-radius: var(--radius) !important; }
    .rounded-xl{ border-radius: var(--radius2) !important; }
    .rounded-md{ border-radius: 12px !important; }
    .rounded-full{ border-radius: 999px !important; }

    /* Inputs / selects */
    input, select, textarea{
      background: rgba(0,0,0,.18) !important;
      border-color: rgba(255,255,255,.14) !important;
      color: var(--text) !important;
      outline: none !important;
    }
    input::placeholder, textarea::placeholder{ color: rgba(169,183,214,.7) !important; }
    input:disabled, select:disabled, textarea:disabled{ opacity: .55 !important; }

    /* Buttons */
    .bg-blue-600{
      background: linear-gradient(135deg, rgba(103,212,255,.85), rgba(139,255,204,.70)) !important;
      border-color: transparent !important;
    }
    .hover\:bg-blue-700:hover{
      filter: brightness(1.05);
    }
    .bg-emerald-600{
      background: linear-gradient(135deg, rgba(71,209,140,.95), rgba(103,212,255,.55)) !important;
      border-color: transparent !important;
    }
    .hover\:bg-emerald-700:hover{
      filter: brightness(1.05);
    }
    .bg-slate-800{ background: rgba(255,255,255,.10) !important; }
    .text-white{ color: #07101d !important; }
    .bg-slate-800.text-white{ color: var(--text) !important; }
    .bg-slate-800:hover{ background: rgba(255,255,255,.14) !important; }

    /* “Selected pill” buttons in the UI */
    .bg-blue-50{ background: rgba(103,212,255,.12) !important; }
    .border-blue-400{ border-color: rgba(103,212,255,.40) !important; }
    .text-blue-700{ color: var(--text) !important; }

    /* Recommendation / best row highlight */
    .bg-emerald-50\/60{ background: rgba(71,209,140,.10) !important; }
    .border-emerald-200{ border-color: rgba(71,209,140,.30) !important; }
    .text-emerald-900{ color: var(--text) !important; }

    /* Table */
    table{ color: var(--text) !important; }
    thead{ color: var(--muted) !important; }
    tbody tr{ border-color: rgba(255,255,255,.10) !important; }

    /* Canvas blocks */
    canvas{ background: rgba(0,0,0,.10) !important; border-color: rgba(255,255,255,.18) !important; }

    /* Small code blocks */
    code{
      background: rgba(0,0,0,.25) !important;
      border: 1px solid rgba(255,255,255,.12);
      padding: 2px 6px;
      border-radius: 10px;
    }

    /* Improve overall spacing on small screens */
    @media (max-width: 640px){
      #root{ padding-top: 18px !important; }
    }
  </style>

</head>
  <body class="min-h-screen">
    <div id="root" class="max-w-6xl mx-auto px-4 py-8"></div>

    <!-- React / ReactDOM / jsPDF / Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const { jsPDF } = window.jspdf;

      // ---------- CONSTANTS ----------

      const DPI = 300;
      const MARGIN_IN = 0.1;
      const SPACING_IN = 0.05;
      const BLEED_IN = 0.125;

      const PRESET_SHEETS = {
        "8.5x11": [8.5, 11],
        "11x17": [11, 17],
        "12x18": [12, 18],
        custom: null
      };

      const PAPER_TYPES = [
        { key: "28lb", label: "28 LB Paper" },
        { key: "20lb", label: "20 LB Paper" },
        { key: "80c", label: "80 LB Cardstock Cover" },
        { key: "110c", label: "110 LB Cardstock Cover" },
        { key: "80t", label: "80 LB Text Gloss" },
        { key: "100t", label: "100 LB Text Gloss" },
        { key: "14pt", label: "14PT Gloss" },
        { key: "18pt", label: "18PT Gloss" }
      ];

      // Which sheet sizes each paper type supports
      const SHEET_KEYS_FOR_PAPER = {
        "28lb": ["8.5x11", "11x17"],
        "20lb": ["8.5x11", "11x17"],
        "80c": ["8.5x11", "11x17"],
        "110c": ["8.5x11", "11x17"],
        "80t": ["8.5x11", "11x17"],
        "100t": ["8.5x11", "11x17"],
        "14pt": ["12x18"],
        "18pt": ["12x18"]
      };

      // Large-format paper types: keys MUST match pricing.json
      const LF_PAPER_TYPES = [
        { key: "hp_super_matte", label: "HP Super Heavyweight Plus Matte Paper" },
        { key: "hp_gloss_photo", label: "HP Universal Instant-dry Gloss Photo Paper" },
        { key: "plain_20lb", label: "20lb Plain Bond Paper" },
        { key: "lexjet_46_bond", label: "LexJet #46 Bright White Bond Paper" },
        { key: "lexjet_thrifty_banner", label: "LexJet TOUGHcoat ThriftyBanner" },
        { key: "lexjet_polypro", label: "LexJet TOUGHcoat Matte Polypropylene v2" },
        { key: "fredrix_canvas", label: "Fredrix 777VWR Vivid Matte Canvas" },
        { key: "hp_adhesive_polypro", label: "HP Everyday Adhesive Matte Polypropylene" },
        { key: "hp_translucent_bond", label: "HP Translucent Bond Paper" }
      ];

      // Blueprint (large format - fixed sizes, 20lb plain bond only)
      const BLUEPRINT_SIZES = [
        { key: "11x17", w: 11, h: 17, label: "11×17" },
        { key: "12x18", w: 12, h: 18, label: "12×18" },
        { key: "17x22", w: 17, h: 22, label: "17×22" },
        { key: "18x24", w: 18, h: 24, label: "18×24" },
        { key: "22x34", w: 22, h: 34, label: "22×34" },
        { key: "24x36", w: 24, h: 36, label: "24×36" },
        { key: "30x42", w: 30, h: 42, label: "30×42" },
        { key: "34x44", w: 34, h: 44, label: "34×44" },
        { key: "36x48", w: 36, h: 48, label: "36×48" }
      ];

      // Defaults based on the uploaded blueprint pricing sheet:
      // - price is configured as "price per sq ft" (PSF)
      // - quantity tiers are per SIZE (sheet count), editable in Admin
      const buildInitialBlueprintPricing = () => {
        const psfDefaults = [1.13, 0.56, 0.48, 0.41];
        const sizeTierMax = {
          "11x17": [50, 150, 400, null],
          "12x18": [50, 150, 400, null],
          "17x22": [33, 100, 266, null],
          "18x24": [33, 100, 266, null],
          "22x34": [16, 50, 133, null],
          "24x36": [16, 50, 133, null],
          "30x42": [11, 33, 88, null],
          "34x44": [9, 27, 72, null],
          "36x48": [8, 25, 66, null]
        };

        const bp = {};
        BLUEPRINT_SIZES.forEach((s) => {
          const maxes = sizeTierMax[s.key] || [50, 150, 400, null];
          bp[s.key] = {
            tiers: [
              { maxQty: maxes[0], psf: psfDefaults[0] },
              { maxQty: maxes[1], psf: psfDefaults[1] },
              { maxQty: maxes[2], psf: psfDefaults[2] },
              { maxQty: maxes[3], psf: psfDefaults[3] }
            ]
          };
        });
        return bp;
      };

      // localStorage keys
      const LS_PRICING_KEY = "printcalc_sheet_pricing_v1";
      const LS_LF_PRICING_KEY = "printcalc_lf_pricing_v1";
      const LS_QTY_DISCOUNTS_KEY = "printcalc_qty_discounts_v1";
      const LS_LF_QTY_DISCOUNTS_KEY = "printcalc_lf_qty_discounts_v1";
      const LS_BACK_FACTOR_KEY = "printcalc_back_factor_v1";
      const LS_LF_ADDONS_KEY = "printcalc_lf_addons_v1";
      const LS_MARKUP_PER_PAPER_KEY = "printcalc_markup_per_paper_v1";
      const LS_LF_MARKUP_PER_PAPER_KEY = "printcalc_lf_markup_per_paper_v1";
      const LS_BP_PRICING_KEY = "printcalc_blueprint_pricing_v1";

      // ---------- HELPERS ----------

      const inchesToPx = (inches) => Math.round(inches * DPI);

      // Sheet pricing internal shape: baseCostColor/baseCostBW + priceColor/priceBW
      const buildInitialPricing = () => {
        const pricing = {};
        PAPER_TYPES.forEach((pt) => {
          pricing[pt.key] = {};
          (SHEET_KEYS_FOR_PAPER[pt.key] || []).forEach((sheetKey) => {
            pricing[pt.key][sheetKey] = {
              baseCostColor: 0,
              baseCostBW: 0,
              priceColor: 0,
              priceBW: 0
            };
          });
        });
        return pricing;
      };

      const buildInitialLfPricing = () => {
        const lf = {};
        LF_PAPER_TYPES.forEach((pt) => {
          lf[pt.key] = {
            baseCostColor: 0, // per sq ft
            baseCostBW: 0, // per sq ft
            priceColor: 0,
            priceBW: 0
          };
        });
        return lf;
      };

      // normalizeEntry: support old shapes and pricing.json shape
      const normalizeEntry = (entry = {}) => {
        const paperCost = Number(entry.paperCost) || 0;
        const colorClickCost = Number(entry.colorClickCost) || 0;
        const bwClickCost = Number(entry.bwClickCost) || 0;

        const fromOldColor = paperCost + colorClickCost;
        const fromOldBW = paperCost + bwClickCost;

        const baseCostColor =
          entry.baseCostColor != null
            ? Number(entry.baseCostColor) || 0
            : fromOldColor;
        const baseCostBW =
          entry.baseCostBW != null ? Number(entry.baseCostBW) || 0 : fromOldBW;

        return {
          baseCostColor,
          baseCostBW,
          priceColor: Number(entry.priceColor) || 0,
          priceBW: Number(entry.priceBW) || 0
        };
      };

      // Simple helper: how many prints per sheet (no bleed here; used for sheet count)
      const computePrintsPerSheet = (sheetWIn, sheetHIn, printWIn, printHIn) => {
        if (printWIn <= 0 || printHIn <= 0) return 1;

        const margin = MARGIN_IN;
        const spacing = SPACING_IN;

        const innerW = sheetWIn - 2 * margin;
        const innerH = sheetHIn - 2 * margin;
        if (innerW <= 0 || innerH <= 0) return 1;

        const cols = Math.max(
          1,
          Math.floor((innerW + spacing) / (printWIn + spacing))
        );
        const rows = Math.max(
          1,
          Math.floor((innerH + spacing) / (printHIn + spacing))
        );
        return cols * rows || 1;
      };

      // ---------- MAIN APP ----------

      function PriceCalculatorApp() {
        const [viewMode, setViewMode] = useState("tool"); // 'tool' | 'quote'
        const [sheetKey, setSheetKey] = useState("8.5x11");
        const [customSize, setCustomSize] = useState({ w: 8.5, h: 11 });
        const [orientation, setOrientation] = useState("portrait");

        const [prints, setPrints] = useState({
          width: 5,
          height: 7,
          quantity: 2
        });

        // Sheet images
        const [frontImage, setFrontImage] = useState(null);
        const [backImage, setBackImage] = useState(null);
        const [frontRotation, setFrontRotation] = useState(0);
        const [backRotation, setBackRotation] = useState(0);
        const [showBack, setShowBack] = useState(false);

        const [showGuides, setShowGuides] = useState(true);
        const [showBleed, setShowBleed] = useState(false);
        const [showCutLines, setShowCutLines] = useState(true);

        const [paperKey, setPaperKey] = useState("28lb");
        const [frontColorMode, setFrontColorMode] = useState("color"); // 'color' | 'bw'
        const [backColorMode, setBackColorMode] = useState("bw");

        // Pricing state
        const [pricing, setPricing] = useState(buildInitialPricing);
        const [lfPricing, setLfPricing] = useState(buildInitialLfPricing);
        const [markupPerPaper, setMarkupPerPaper] = useState(() => {
          const init = {};
          PAPER_TYPES.forEach((pt) => (init[pt.key] = 0));
          return init;
        });
        const [lfMarkupPerPaper, setLfMarkupPerPaper] = useState(() => {
          const init = {};
          LF_PAPER_TYPES.forEach((pt) => (init[pt.key] = 0));
          return init;
        });

        const [quantityDiscounts, setQuantityDiscounts] = useState([
          { minSheets: 0, discountPercent: 0 }
        ]);
        const [lfQuantityDiscounts, setLfQuantityDiscounts] = useState([
          { minSqFt: 0, discountPercent: 0 }
        ]);

        const [backSideFactor, setBackSideFactor] = useState(0.5);

        const [lfAddonPricing, setLfAddonPricing] = useState({
          grommets: 0,
          foamCore: 0,
          coroSign: 0
        });

        // Blueprint state (large format - fixed sizes, 20lb plain bond only)
        const [bpPricing, setBpPricing] = useState(
          buildInitialBlueprintPricing
        );
        const [bpSizeKey, setBpSizeKey] = useState("24x36");
        const [bpQty, setBpQty] = useState(1);
        const [bpMaintainProp, setBpMaintainProp] = useState(true);
        const [bpImage, setBpImage] = useState(null);
        const [bpRotation, setBpRotation] = useState(0);

        // Admin toggles
        const [isAdmin, setIsAdmin] = useState(false);
        const [showAdmin, setShowAdmin] = useState(false);

        // Quick quote state
        const [quoteWidth, setQuoteWidth] = useState(5);
        const [quoteHeight, setQuoteHeight] = useState(7);
        const [quoteQty, setQuoteQty] = useState(500);
        const [quoteBackEnabled, setQuoteBackEnabled] = useState(false);
        const [quoteBackColorMode, setQuoteBackColorMode] = useState("bw");
        const [quoteFrontColorMode, setQuoteFrontColorMode] =
          useState("color");
        const [quoteDocPages, setQuoteDocPages] = useState(0);
        const [quoteDocDuplex, setQuoteDocDuplex] = useState(true);

        // Quick Quote filters
        const [quotePaperKey, setQuotePaperKey] = useState("28lb");
        const [quoteShowAllPapers, setQuoteShowAllPapers] = useState(false);

        // Large-format state (simple version)
        const [lfWidth, setLfWidth] = useState(24); // in
        const [lfHeight, setLfHeight] = useState(36); // in
        const [lfPaperKey, setLfPaperKey] = useState(LF_PAPER_TYPES[0].key);
        const [lfColorMode, setLfColorMode] = useState("color");
        const [lfMaintainProp, setLfMaintainProp] = useState(true);
        const [lfImage, setLfImage] = useState(null);
        const [lfRotation, setLfRotation] = useState(0);
        const [lfGrommets, setLfGrommets] = useState(false);
        const [lfFoamCore, setLfFoamCore] = useState(false);
        const [lfCoroSign, setLfCoroSign] = useState(false);

        // Canvases
        const frontRef = useRef(null);
        const backRef = useRef(null);
        const lfRef = useRef(null);
        const bpRef = useRef(null);

        // -------- LOAD FROM localStorage + pricing.json --------

        useEffect(() => {
          (async () => {
            try {
              // 1) localStorage first
              const lsPricing = window.localStorage.getItem(LS_PRICING_KEY);
              const lsLfPricing = window.localStorage.getItem(
                LS_LF_PRICING_KEY
              );
              const lsQty = window.localStorage.getItem(LS_QTY_DISCOUNTS_KEY);
              const lsLfQty = window.localStorage.getItem(
                LS_LF_QTY_DISCOUNTS_KEY
              );
              const lsBack = window.localStorage.getItem(LS_BACK_FACTOR_KEY);
              const lsLfAddons = window.localStorage.getItem(
                LS_LF_ADDONS_KEY
              );
              const lsMarkup = window.localStorage.getItem(
                LS_MARKUP_PER_PAPER_KEY
              );
              const lsLfMarkup = window.localStorage.getItem(
                LS_LF_MARKUP_PER_PAPER_KEY
              );
              const lsBp = window.localStorage.getItem(
                LS_BP_PRICING_KEY
              );

              if (lsPricing) setPricing(JSON.parse(lsPricing));
              if (lsLfPricing) setLfPricing(JSON.parse(lsLfPricing));
              if (lsQty) setQuantityDiscounts(JSON.parse(lsQty));
              if (lsLfQty) setLfQuantityDiscounts(JSON.parse(lsLfQty));
              if (lsBack) setBackSideFactor(parseFloat(lsBack) || 0.5);
              if (lsLfAddons) setLfAddonPricing(JSON.parse(lsLfAddons));
              if (lsMarkup)
                setMarkupPerPaper((prev) => ({
                  ...prev,
                  ...JSON.parse(lsMarkup)
                }));
              if (lsLfMarkup)
                setLfMarkupPerPaper((prev) => ({
                  ...prev,
                  ...JSON.parse(lsLfMarkup)
                }));
              if (lsBp) setBpPricing(JSON.parse(lsBp));

              // 2) pricing.json from site root
              const resp = await fetch("pricing.json", {
                cache: "no-store"
              });
              if (resp.ok) {
                const json = await resp.json();

                // Sheet pricing
                if (json.sheetPricing) {
                  setPricing(json.sheetPricing);
                  window.localStorage.setItem(
                    LS_PRICING_KEY,
                    JSON.stringify(json.sheetPricing)
                  );
                }

                // Large format pricing
                if (json.lfPricing) {
                  const mergedLf = buildInitialLfPricing();
                  for (const k in json.lfPricing) {
                    if (mergedLf[k]) {
                      mergedLf[k] = { ...mergedLf[k], ...json.lfPricing[k] };
                    } else {
                      mergedLf[k] = json.lfPricing[k];
                    }
                  }
                  setLfPricing(mergedLf);
                  window.localStorage.setItem(
                    LS_LF_PRICING_KEY,
                    JSON.stringify(mergedLf)
                  );
                }

                // Sheet quantity discounts
                if (json.quantityDiscounts) {
                  setQuantityDiscounts(json.quantityDiscounts);
                  window.localStorage.setItem(
                    LS_QTY_DISCOUNTS_KEY,
                    JSON.stringify(json.quantityDiscounts)
                  );
                } else if (json.sheetQtyDiscounts) {
                  const mapped = json.sheetQtyDiscounts.map((t) => ({
                    minSheets:
                      t.minSheets != null ? t.minSheets : t.minQty || 0,
                    discountPercent: Number(t.discountPercent) || 0
                  }));
                  setQuantityDiscounts(mapped);
                  window.localStorage.setItem(
                    LS_QTY_DISCOUNTS_KEY,
                    JSON.stringify(mapped)
                  );
                }

                // LF quantity discounts
                if (json.lfQuantityDiscounts) {
                  setLfQuantityDiscounts(json.lfQuantityDiscounts);
                  window.localStorage.setItem(
                    LS_LF_QTY_DISCOUNTS_KEY,
                    JSON.stringify(json.lfQuantityDiscounts)
                  );
                } else if (json.lfQtyDiscounts) {
                  const mappedLf = json.lfQtyDiscounts.map((t) => ({
                    minSqFt:
                      t.minSqFt != null ? t.minSqFt : t.minQty || 0,
                    discountPercent: Number(t.discountPercent) || 0
                  }));
                  setLfQuantityDiscounts(mappedLf);
                  window.localStorage.setItem(
                    LS_LF_QTY_DISCOUNTS_KEY,
                    JSON.stringify(mappedLf)
                  );
                }

                // Per-paper markup
                if (json.sheetMarkupPerPaper) {
                  setMarkupPerPaper((prev) => ({
                    ...prev,
                    ...json.sheetMarkupPerPaper
                  }));
                  window.localStorage.setItem(
                    LS_MARKUP_PER_PAPER_KEY,
                    JSON.stringify({
                      ...markupPerPaper,
                      ...json.sheetMarkupPerPaper
                    })
                  );
                }
                if (json.lfMarkupPerPaper) {
                  setLfMarkupPerPaper((prev) => ({
                    ...prev,
                    ...json.lfMarkupPerPaper
                  }));
                  window.localStorage.setItem(
                    LS_LF_MARKUP_PER_PAPER_KEY,
                    JSON.stringify({
                      ...lfMarkupPerPaper,
                      ...json.lfMarkupPerPaper
                    })
                  );
                }

                if (typeof json.backSideFactor === "number") {
                  setBackSideFactor(json.backSideFactor);
                  window.localStorage.setItem(
                    LS_BACK_FACTOR_KEY,
                    String(json.backSideFactor)
                  );
                }

                if (json.lfAddonPricing) {
                  setLfAddonPricing(json.lfAddonPricing);
                  window.localStorage.setItem(
                    LS_LF_ADDONS_KEY,
                    JSON.stringify(json.lfAddonPricing)
                  );
                }

                // Blueprint pricing (large format - fixed sizes)
                if (json.blueprintPricing) {
                  setBpPricing(json.blueprintPricing);
                  window.localStorage.setItem(
                    LS_BP_PRICING_KEY,
                    JSON.stringify(json.blueprintPricing)
                  );
                }
              }
            } catch (err) {
              console.error("Error loading pricing.json/localStorage", err);
            }
          })();
        }, []);

        // Autosave key states
        useEffect(() => {
          window.localStorage.setItem(
            LS_PRICING_KEY,
            JSON.stringify(pricing)
          );
        }, [pricing]);

        useEffect(() => {
          window.localStorage.setItem(
            LS_LF_PRICING_KEY,
            JSON.stringify(lfPricing)
          );
        }, [lfPricing]);

        useEffect(() => {
          window.localStorage.setItem(
            LS_QTY_DISCOUNTS_KEY,
            JSON.stringify(quantityDiscounts)
          );
        }, [quantityDiscounts]);

        useEffect(() => {
          window.localStorage.setItem(
            LS_LF_QTY_DISCOUNTS_KEY,
            JSON.stringify(lfQuantityDiscounts)
          );
        }, [lfQuantityDiscounts]);

        useEffect(() => {
          window.localStorage.setItem(
            LS_BACK_FACTOR_KEY,
            String(backSideFactor)
          );
        }, [backSideFactor]);

        useEffect(() => {
          window.localStorage.setItem(
            LS_LF_ADDONS_KEY,
            JSON.stringify(lfAddonPricing)
          );
        }, [lfAddonPricing]);

        useEffect(() => {
          window.localStorage.setItem(
            LS_MARKUP_PER_PAPER_KEY,
            JSON.stringify(markupPerPaper)
          );
        }, [markupPerPaper]);

        useEffect(() => {
          window.localStorage.setItem(
            LS_LF_MARKUP_PER_PAPER_KEY,
            JSON.stringify(lfMarkupPerPaper)
          );
        }, [lfMarkupPerPaper]);

        useEffect(() => {
          window.localStorage.setItem(
            LS_BP_PRICING_KEY,
            JSON.stringify(bpPricing)
          );
        }, [bpPricing]);

        // -------- SHEET GEOMETRY --------

        const getSheetInches = () => {
          if (sheetKey === "custom") {
            const w = Math.max(0.1, Number(customSize.w) || 0);
            const h = Math.max(0.1, Number(customSize.h) || 0);
            return [w, h];
          }
          return PRESET_SHEETS[sheetKey];
        };

        const [sheetWIn, sheetHIn] = getSheetInches();
        const orientedWIn =
          orientation === "portrait" ? sheetWIn : sheetHIn;
        const orientedHIn =
          orientation === "portrait" ? sheetHIn : sheetWIn;

        // How many prints per sheet based on print size (no bleed here — for sheet count)
        const printsPerSheet = computePrintsPerSheet(
          orientedWIn,
          orientedHIn,
          prints.width,
          prints.height
        );
        const sheetsNeeded = Math.max(
          1,
          Math.ceil(
            (Number(prints.quantity) || 0) / Math.max(1, printsPerSheet)
          )
        );

        const currentPaper =
          PAPER_TYPES.find((pt) => pt.key === paperKey) || PAPER_TYPES[0];
        const comboAllowed = (SHEET_KEYS_FOR_PAPER[paperKey] || []).includes(
          sheetKey
        );

        const selectedPricingRaw =
          (pricing[paperKey] || {})[sheetKey] || {};
        const selectedPricing = normalizeEntry(selectedPricingRaw);
        const baseColorCost = selectedPricing.baseCostColor;
        const baseBWCost = selectedPricing.baseCostBW;

        const effectiveFrontPerSheet =
          frontColorMode === "color"
            ? selectedPricing.priceColor
            : selectedPricing.priceBW;

        const effectiveBackPerSheet =
          showBack && backSideFactor > 0
            ? (backColorMode === "color"
                ? selectedPricing.priceColor
                : selectedPricing.priceBW) * backSideFactor
            : 0;

        const perSheetTotal = effectiveFrontPerSheet + effectiveBackPerSheet;

        // Apply quantity discount
        const getSheetDiscountFactor = (sheetCount) => {
          let best = 0;
          quantityDiscounts.forEach((t) => {
            if (sheetCount >= (t.minSheets || 0)) {
              best = Math.max(best, Number(t.discountPercent) || 0);
            }
          });
          return 1 - best / 100;
        };

        const discountFactor = getSheetDiscountFactor(sheetsNeeded);
        const totalPrice = perSheetTotal * sheetsNeeded * discountFactor;

        // -------- DRAW FRONT/BACK CANVAS --------

        const drawSheet = (canvas, imageFile, rotationDeg) => {
          if (!canvas) return;
          const ctx = canvas.getContext("2d");

          const wPx = inchesToPx(orientedWIn);
          const hPx = inchesToPx(orientedHIn);

          canvas.width = wPx;
          canvas.height = hPx;

          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, wPx, hPx);

          if (!imageFile) return;

          const marginPx = inchesToPx(MARGIN_IN);
          const spacingPx = inchesToPx(SPACING_IN);
          const bleedPx = showBleed ? inchesToPx(BLEED_IN) : 0;

          const targetWPx = inchesToPx(prints.width) + bleedPx * 2;
          const targetHPx = inchesToPx(prints.height) + bleedPx * 2;

          const img = new Image();
          img.onload = () => {
            // Compute columns & rows including bleed box
            const innerW = wPx - 2 * marginPx;
            const innerH = hPx - 2 * marginPx;
            if (innerW <= 0 || innerH <= 0) return;

            const cols = Math.max(
              1,
              Math.floor((innerW + spacingPx) / (targetWPx + spacingPx))
            );
            const rows = Math.max(
              1,
              Math.floor((innerH + spacingPx) / (targetHPx + spacingPx))
            );

            const totalW =
              cols * targetWPx + (cols - 1) * spacingPx;
            const totalH =
              rows * targetHPx + (rows - 1) * spacingPx;

            const offX = marginPx + (innerW - totalW) / 2;
            const offY = marginPx + (innerH - totalH) / 2;

            let placed = 0;
            let firstX = null;
            let firstY = null;
            let firstW = null;
            let firstH = null;

            for (let r = 0; r < rows && placed < prints.quantity; r++) {
              for (let c = 0; c < cols && placed < prints.quantity; c++) {
                const x = offX + c * (targetWPx + spacingPx);
                const y = offY + r * (targetHPx + spacingPx);

                if (firstX == null) {
                  firstX = x;
                  firstY = y;
                  firstW = targetWPx;
                  firstH = targetHPx;
                }

                ctx.save();
                // Draw cut box (target area including bleed)
                if (showCutLines) {
                  ctx.strokeStyle = "#000";
                  ctx.lineWidth = 1;
                  ctx.strokeRect(x, y, targetWPx, targetHPx);
                }

                // Draw image inside bleed box, rotated
                ctx.translate(
                  x + targetWPx / 2,
                  y + targetHPx / 2
                );
                const rad = (rotationDeg * Math.PI) / 180;
                ctx.rotate(rad);

                const contentW = targetWPx - bleedPx * 2;
                const contentH = targetHPx - bleedPx * 2;

                let drawW = contentW;
                let drawH = (img.height / img.width) * contentW;
                if (drawH < contentH) {
                  drawH = contentH;
                  drawW = (img.width / img.height) * contentH;
                }

                ctx.drawImage(
                  img,
                  -contentW / 2,
                  -contentH / 2,
                  contentW,
                  contentH
                );

                // If grayscale (for B/W preview), apply a simple overlay
                if (frontColorMode === "bw" || backColorMode === "bw") {
                  // handled outside per side; here we just draw color,
                  // but to keep it simple we'll not apply grayscale at canvas level
                }

                ctx.restore();
                placed++;
              }
            }

            // Measurement guides (from left/top edges to first image)
            if (showGuides && firstX != null) {
              const leftIn = (firstX / DPI).toFixed(2);
              const topIn = (firstY / DPI).toFixed(2);

              ctx.strokeStyle = "red";
              ctx.fillStyle = "red";
              ctx.lineWidth = 1;
              ctx.font = "12px sans-serif";

              // Horizontal guide
              ctx.beginPath();
              ctx.moveTo(0, firstY + firstH + 20);
              ctx.lineTo(firstX, firstY + firstH + 20);
              ctx.stroke();
              const leftText = leftIn + " in";
              const leftWidth = ctx.measureText(leftText).width;
              ctx.fillText(
                leftText,
                firstX / 2 - leftWidth / 2,
                firstY + firstH + 15
              );

              // Vertical guide
              ctx.beginPath();
              ctx.moveTo(firstX + firstW + 20, 0);
              ctx.lineTo(firstX + firstW + 20, firstY);
              ctx.stroke();
              const topText = topIn + " in";
              ctx.fillText(
                topText,
                firstX + firstW + 25,
                firstY / 2 + 4
              );
            }
          };
          img.src = URL.createObjectURL(imageFile);
        };

        useEffect(() => {
          drawSheet(frontRef.current, frontImage, frontRotation);
        }, [
          frontImage,
          frontRotation,
          sheetKey,
          orientation,
          customSize,
          prints,
          showBleed,
          showCutLines,
          showGuides
        ]);

        useEffect(() => {
          if (showBack) {
            drawSheet(backRef.current, backImage, backRotation);
          }
        }, [
          backImage,
          backRotation,
          sheetKey,
          orientation,
          customSize,
          prints,
          showBleed,
          showCutLines,
          showGuides,
          showBack
        ]);

        // -------- LARGE FORMAT PREVIEW --------

        const lfAreaSqFt = (lfWidth * lfHeight) / 144;

        const lfSelectedPricing = normalizeEntry(
          lfPricing[lfPaperKey] || {}
        );
        const lfBase =
          lfColorMode === "color"
            ? lfSelectedPricing.priceColor
            : lfSelectedPricing.priceBW;
        const lfSubtotal = lfBase * lfAreaSqFt;

        const lfAddonTotal =
          (lfGrommets ? lfAddonPricing.grommets || 0 : 0) +
          (lfFoamCore ? lfAddonPricing.foamCore || 0 : 0) +
          (lfCoroSign ? lfAddonPricing.coroSign || 0 : 0);

        const lfTotal = lfSubtotal + lfAddonTotal;

        const getLfDiscountFactor = (sqFt) => {
          let best = 0;
          lfQuantityDiscounts.forEach((t) => {
            if (sqFt >= (t.minSqFt || 0)) {
              best = Math.max(best, Number(t.discountPercent) || 0);
            }
          });
          return 1 - best / 100;
        };

        const lfTotalWithDiscount = lfTotal * getLfDiscountFactor(lfAreaSqFt);

        // -------- BLUEPRINT (PRESET LARGE FORMAT SIZES) --------

        const getBlueprintSize = (key) =>
          BLUEPRINT_SIZES.find((s) => s.key === key) || BLUEPRINT_SIZES[0];

        const bpSize = getBlueprintSize(bpSizeKey);
        const bpWidth = bpSize.w;
        const bpHeight = bpSize.h;

        const bpAreaPerSheetSqFt = (bpWidth * bpHeight) / 144;
        const bpTotalSqFt = bpAreaPerSheetSqFt * Math.max(0, bpQty || 0);

        const getBlueprintTier = (sizeKey, qty) => {
          const cfg = (bpPricing || {})[sizeKey] || {};
          const tiers = Array.isArray(cfg.tiers) ? cfg.tiers : [];
          const q = Math.max(0, Number(qty) || 0);

          // pick first tier whose maxQty is null (open-ended) or >= qty
          for (const t of tiers) {
            const maxQ = t.maxQty == null ? null : Number(t.maxQty);
            if (maxQ == null || q <= maxQ) {
              return {
                maxQty: maxQ,
                psf: Number(t.psf) || 0
              };
            }
          }
          // fallback: last tier
          const last = tiers[tiers.length - 1] || { maxQty: null, psf: 0 };
          return { maxQty: last.maxQty == null ? null : Number(last.maxQty), psf: Number(last.psf) || 0 };
        };

        const bpTier = getBlueprintTier(bpSizeKey, bpQty);
        const bpPsf = bpTier.psf;

        const bpPerSheet = bpPsf * bpAreaPerSheetSqFt;
        const bpTotal = bpPerSheet * Math.max(0, Number(bpQty) || 0);

        const drawBlueprint = (canvas, imgFile) => {
          if (!canvas) return;
          const ctx = canvas.getContext("2d");

          const wPx = inchesToPx(bpWidth);
          const hPx = inchesToPx(bpHeight);

          canvas.width = wPx;
          canvas.height = hPx;

          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, wPx, hPx);

          if (!imgFile) return;

          const img = new Image();
          img.onload = () => {
            ctx.save();
            ctx.translate(wPx / 2, hPx / 2);
            const rad = (bpRotation * Math.PI) / 180;
            ctx.rotate(rad);

            let drawW = wPx;
            let drawH = (img.height / img.width) * wPx;
            if (bpMaintainProp) {
              if (drawH > hPx) {
                drawH = hPx;
                drawW = (img.width / img.height) * hPx;
              }
            } else {
              drawW = wPx;
              drawH = hPx;
            }

            ctx.drawImage(img, -drawW / 2, -drawH / 2, drawW, drawH);
            ctx.restore();
          };
          img.src = URL.createObjectURL(imgFile);
        };

        useEffect(() => {
          drawBlueprint(bpRef.current, bpImage);
        }, [bpImage, bpSizeKey, bpMaintainProp, bpRotation]);

        const drawLargeFormat = (canvas, imgFile) => {
          if (!canvas) return;
          const ctx = canvas.getContext("2d");

          const wPx = inchesToPx(lfWidth);
          const hPx = inchesToPx(lfHeight);

          canvas.width = wPx;
          canvas.height = hPx;

          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, wPx, hPx);

          if (!imgFile) return;

          const img = new Image();
          img.onload = () => {
            ctx.save();
            ctx.translate(wPx / 2, hPx / 2);
            const rad = (lfRotation * Math.PI) / 180;
            ctx.rotate(rad);

            let drawW = wPx;
            let drawH = (img.height / img.width) * wPx;
            if (lfMaintainProp) {
              if (drawH > hPx) {
                drawH = hPx;
                drawW = (img.width / img.height) * hPx;
              }
            } else {
              // stretch to fit
              drawW = wPx;
              drawH = hPx;
            }

            ctx.drawImage(img, -drawW / 2, -drawH / 2, drawW, drawH);
            ctx.restore();
          };
          img.src = URL.createObjectURL(imgFile);
        };

        useEffect(() => {
          drawLargeFormat(lfRef.current, lfImage);
        }, [lfImage, lfWidth, lfHeight, lfMaintainProp, lfRotation]);

        // -------- PDF EXPORTS --------

        const downloadSheetPDF = () => {
          if (!frontRef.current) return;

          const pdfW = orientedWIn;
          const pdfH = orientedHIn;

          const doc = new jsPDF({
            orientation,
            unit: "in",
            format: [pdfW, pdfH]
          });

          const frontData = frontRef.current.toDataURL("image/png", 1.0);
          doc.addImage(frontData, "PNG", 0, 0, pdfW, pdfH);

          if (showBack && backRef.current && backImage) {
            doc.addPage([pdfW, pdfH], orientation);
            const backData = backRef.current.toDataURL("image/png", 1.0);
            doc.addImage(backData, "PNG", 0, 0, pdfW, pdfH);
          }

          doc.save("print_preview.pdf");
        };

        const downloadLfPDF = () => {
          if (!lfRef.current) return;
          const pdfW = lfWidth;
          const pdfH = lfHeight;

          const doc = new jsPDF({
            orientation: pdfW >= pdfH ? "landscape" : "portrait",
            unit: "in",
            format: [pdfW, pdfH]
          });

          const data = lfRef.current.toDataURL("image/png", 1.0);
          doc.addImage(data, "PNG", 0, 0, pdfW, pdfH);
          doc.save("large_format_preview.pdf");
        };

        const downloadBlueprintPDF = () => {
          if (!bpRef.current) return;
          const pdfW = bpWidth;
          const pdfH = bpHeight;

          const doc = new jsPDF({
            orientation: pdfW >= pdfH ? "landscape" : "portrait",
            unit: "in",
            format: [pdfW, pdfH]
          });

          const data = bpRef.current.toDataURL("image/png", 1.0);
          doc.addImage(data, "PNG", 0, 0, pdfW, pdfH);
          doc.save("blueprint_preview.pdf");
        };

        // -------- EMAIL ORDER (Netlify Function) --------

        const sendOrderEmail = async (jobType, pdfBlob) => {
          try {
            const reader = new FileReader();
            const base64 = await new Promise((resolve, reject) => {
              reader.onloadend = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(pdfBlob);
            });

            const prefix = "data:application/pdf;base64,";
            const pdfBase64 = base64.startsWith(prefix)
              ? base64.slice(prefix.length)
              : base64;

            console.log("pdfBase64 length (client):", pdfBase64.length);

            // Safety: Netlify body size limit ~10MB => ~7.5MB raw => ~10MB base64
            const MAX_LEN = 10 * 1024 * 1024;
            if (pdfBase64.length > MAX_LEN) {
              alert(
                "The generated PDF is too large to send automatically. Please download it and email manually."
              );
              return false;
            }

            const name = window.prompt("Your name (for the order)?") || "";
            const email =
              window.prompt("Your email (for confirmation)?") || "";
            const phone =
              window.prompt("Your phone number (optional)?") || "";

            const details = {
              jobType,
              sheet: {
                sheetKey,
                orientation,
                prints,
                paperKey,
                frontColorMode,
                backColorMode,
                showBack,
                sheetsNeeded,
                totalPrice: totalPrice.toFixed(2)
              },
              largeFormat: {
                width: lfWidth,
                height: lfHeight,
                paperKey: lfPaperKey,
                colorMode: lfColorMode,
                addons: {
                  grommets: lfGrommets,
                  foamCore: lfFoamCore,
                  coroSign: lfCoroSign
                },
                lfTotal: lfTotalWithDiscount.toFixed(2)
              },
              blueprints: {
                size: bpSizeKey,
                width: bpWidth,
                height: bpHeight,
                qty: bpQty,
                paperKey: "plain_20lb",
                colorMode: "bw",
                psf: Number(bpPsf || 0).toFixed(4),
                areaPerSheetSqFt: bpAreaPerSheetSqFt.toFixed(3),
                totalSqFt: bpTotalSqFt.toFixed(3),
                total: bpTotal.toFixed(2)
              },
              user: { name, email, phone }
            };

            const payload = {
              subject: "PRINT JOB",
              to: "store4979@theupsstore.com",
              jobType,
              details,
              pdfBase64
            };

            const resp = await fetch(
              "/.netlify/functions/send-print-job",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
              }
            );

            if (!resp.ok) {
              console.error("Server error:", resp.status);
              alert(
                "Could not send order automatically. Please download the PDF and email it to store4979@theupsstore.com."
              );
              return false;
            }
            alert(
              "Order sent! We'll receive your job details by email shortly."
            );
            return true;
          } catch (err) {
            console.error("sendOrderEmail error:", err);
            alert(
              "Could not send order automatically. Please download the PDF and email it to store4979@theupsstore.com."
            );
            return false;
          }
        };

        const orderSheetJob = async () => {
          if (!frontRef.current) {
            alert("Please upload a front image first.");
            return;
          }
          const pdfW = orientedWIn;
          const pdfH = orientedHIn;

          const doc = new jsPDF({
            orientation,
            unit: "in",
            format: [pdfW, pdfH]
          });

          const frontData = frontRef.current.toDataURL("image/png", 1.0);
          doc.addImage(frontData, "PNG", 0, 0, pdfW, pdfH);

          if (showBack && backRef.current && backImage) {
            doc.addPage([pdfW, pdfH], orientation);
            const backData = backRef.current.toDataURL(
              "image/png",
              1.0
            );
            doc.addImage(backData, "PNG", 0, 0, pdfW, pdfH);
          }

          const blob = doc.output("blob");
          await sendOrderEmail("sheets", blob);
        };

        const orderLargeFormatJob = async () => {
          if (!lfRef.current) {
            alert("Please upload a large-format image first.");
            return;
          }
          const pdfW = lfWidth;
          const pdfH = lfHeight;

          const doc = new jsPDF({
            orientation: pdfW >= pdfH ? "landscape" : "portrait",
            unit: "in",
            format: [pdfW, pdfH]
          });

          const data = lfRef.current.toDataURL("image/png", 1.0);
          doc.addImage(data, "PNG", 0, 0, pdfW, pdfH);
          const blob = doc.output("blob");
          await sendOrderEmail("large-format", blob);
        };



        const orderBlueprintJob = async () => {
          if (!bpRef.current) {
            alert("Please upload a blueprint image first.");
            return;
          }
          const pdfW = bpWidth;
          const pdfH = bpHeight;

          const doc = new jsPDF({
            orientation: pdfW >= pdfH ? "landscape" : "portrait",
            unit: "in",
            format: [pdfW, pdfH]
          });

          const data = bpRef.current.toDataURL("image/png", 1.0);
          doc.addImage(data, "PNG", 0, 0, pdfW, pdfH);
          const blob = doc.output("blob");
          await sendOrderEmail("blueprints", blob);
        };

        // -------- ADMIN ACTIONS --------

        const handleAdminClick = () => {
          if (!isAdmin) {
            const pwd = window.prompt("Enter admin password");
            if (pwd === "store4979") {
              setIsAdmin(true);
              setShowAdmin(true);
            } else {
              alert("Incorrect password");
            }
          } else {
            setShowAdmin((v) => !v);
          }
        };

        const applyMarkupForPaper = (pk) => {
          const m = parseFloat(markupPerPaper[pk]) || 0;
          const factor = 1 + m / 100;
          setPricing((prev) => {
            const next = { ...prev };
            const group = prev[pk] || {};
            next[pk] = {};
            for (const sk in group) {
              const normalized = normalizeEntry(group[sk]);
              const baseColor = normalized.baseCostColor;
              const baseBW = normalized.baseCostBW;
              next[pk][sk] = {
                ...normalized,
                priceColor: parseFloat((baseColor * factor).toFixed(4)),
                priceBW: parseFloat((baseBW * factor).toFixed(4))
              };
            }
            return next;
          });
        };

        const applyMarkupForAllPapers = () => {
          setPricing((prev) => {
            const next = {};
            for (const pk in prev) {
              const m = parseFloat(markupPerPaper[pk]) || 0;
              const factor = 1 + m / 100;
              const group = prev[pk] || {};
              next[pk] = {};
              for (const sk in group) {
                const normalized = normalizeEntry(group[sk]);
                const baseColor = normalized.baseCostColor;
                const baseBW = normalized.baseCostBW;
                next[pk][sk] = {
                  ...normalized,
                  priceColor: parseFloat((baseColor * factor).toFixed(4)),
                  priceBW: parseFloat((baseBW * factor).toFixed(4))
                };
              }
            }
            return next;
          });
        };

        const applyLfMarkupForPaper = (pk) => {
          const m = parseFloat(lfMarkupPerPaper[pk]) || 0;
          const factor = 1 + m / 100;
          setLfPricing((prev) => {
            const next = { ...prev };
            const entry = normalizeEntry(prev[pk] || {});
            const baseColor = entry.baseCostColor;
            const baseBW = entry.baseCostBW;
            next[pk] = {
              ...entry,
              priceColor: parseFloat((baseColor * factor).toFixed(4)),
              priceBW: parseFloat((baseBW * factor).toFixed(4))
            };
            return next;
          });
        };

        const applyLfMarkupForAll = () => {
          setLfPricing((prev) => {
            const next = {};
            for (const pk in prev) {
              const m = parseFloat(lfMarkupPerPaper[pk]) || 0;
              const factor = 1 + m / 100;
              const entry = normalizeEntry(prev[pk] || {});
              const baseColor = entry.baseCostColor;
              const baseBW = entry.baseCostBW;
              next[pk] = {
                ...entry,
                priceColor: parseFloat((baseColor * factor).toFixed(4)),
                priceBW: parseFloat((baseBW * factor).toFixed(4))
              };
            }
            return next;
          });
        };

        const exportPricingJson = () => {
          const data = {
            sheetPricing: pricing,
            lfPricing,
            blueprintPricing: bpPricing,
            sheetQtyDiscounts: quantityDiscounts,
            lfQtyDiscounts: lfQuantityDiscounts,
            sheetMarkupPerPaper: markupPerPaper,
            lfMarkupPerPaper,
            backSideFactor,
            lfAddonPricing
          };
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json"
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "pricing.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        };

        const importPricingJson = (file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const json = JSON.parse(e.target.result);

              if (json.sheetPricing) setPricing(json.sheetPricing);
              if (json.lfPricing) setLfPricing(json.lfPricing);
              if (json.blueprintPricing) setBpPricing(json.blueprintPricing);
              if (json.sheetQtyDiscounts)
                setQuantityDiscounts(json.sheetQtyDiscounts);
              if (json.lfQtyDiscounts)
                setLfQuantityDiscounts(json.lfQtyDiscounts);

              if (json.sheetMarkupPerPaper)
                setMarkupPerPaper((prev) => ({
                  ...prev,
                  ...json.sheetMarkupPerPaper
                }));
              if (json.lfMarkupPerPaper)
                setLfMarkupPerPaper((prev) => ({
                  ...prev,
                  ...json.lfMarkupPerPaper
                }));

              if (typeof json.backSideFactor === "number")
                setBackSideFactor(json.backSideFactor);
              if (json.lfAddonPricing) setLfAddonPricing(json.lfAddonPricing);

              alert("Pricing JSON imported.");
            } catch (err) {
              alert("Could not parse pricing JSON.");
            }
          };
          reader.readAsText(file);
        };

        // -------- QUICK QUOTE CALCULATIONS --------

        const computeQuickQuoteRows = () => {
          const rows = [];
          const sizes = quoteShowAllPapers
            ? Object.keys(PRESET_SHEETS).filter((k) => k !== "custom")
            : SHEET_KEYS_FOR_PAPER[quotePaperKey] || [];

          sizes.forEach((sk) => {
            const [sW, sH] = PRESET_SHEETS[sk];
            const orientedW = sW;
            const orientedH = sH;

            PAPER_TYPES.forEach((pt) => {
              if (!SHEET_KEYS_FOR_PAPER[pt.key].includes(sk)) return;
              const entry = normalizeEntry(
                (pricing[pt.key] || {})[sk] || {}
              );
              if (!entry.priceColor && !entry.priceBW) return;

              const perSheet =
                quoteFrontColorMode === "color"
                  ? entry.priceColor
                  : entry.priceBW;

              const perSheetBack =
                quoteBackEnabled && backSideFactor > 0
                  ? (quoteBackColorMode === "color"
                      ? entry.priceColor
                      : entry.priceBW) * backSideFactor
                  : 0;

              const printsPer =
                computePrintsPerSheet(
                  orientedW,
                  orientedH,
                  quoteWidth,
                  quoteHeight
                ) || 1;
              const sheets = Math.ceil(
                (quoteQty || 0) / printsPer
              );

              const discFactor = getSheetDiscountFactor(sheets);
              const total =
                (perSheet + perSheetBack) * sheets * discFactor;

              rows.push({
                paperLabel: pt.label,
                sheetKey: sk,
                perSheetFront: perSheet,
                perSheetBack,
                printsPer,
                sheets,
                total
              });
            });
          });

          return rows.sort((a, b) => a.total - b.total);
        };

        
        const printQuickQuote = () => {
          const rows = computeQuickQuoteRows();
          if (!rows.length) {
            alert("Nothing to print yet. Enter your quote details first.");
            return;
          }

          const paperLabel = (key) =>
            (PAPER_TYPES.find((p) => p.key === key) || {}).label || key;

          const now = new Date();
          const headerTitle = "Print Quote";
          const selectedPaperText = quoteShowAllPapers
            ? "All paper types"
            : paperLabel(quotePaperKey);

          const tableHeaders = quoteShowAllPapers
            ? ["Paper", "Sheet", "Prints/Sheet", "Sheets", "Front/Back per Sheet", "Total"]
            : ["Sheet", "Prints/Sheet", "Sheets", "Front/Back per Sheet", "Total"];

          const rowHtml = rows
            .map((r) => {
              const cols = [];
              if (quoteShowAllPapers) cols.push(`<td>${r.paperLabel}</td>`);
              cols.push(
                `<td>${r.sheetKey}</td>`,
                `<td style="text-align:right">${r.printsPer}</td>`,
                `<td style="text-align:right">${r.sheets}</td>`,
                `<td style="text-align:right">$${r.perSheetFront.toFixed(4)} / $${r.perSheetBack.toFixed(4)}</td>`,
                `<td style="text-align:right"><b>$${r.total.toFixed(2)}</b></td>`
              );
              return `<tr>${cols.join("")}</tr>`;
            })
            .join("");

          const best = rows.slice().sort((a, b) => a.total - b.total)[0];

          const w = window.open("", "_blank", "width=900,height=700");
          if (!w) return;

          w.document.write(`
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>${headerTitle}</title>
<style>
  body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:24px; color:#0f172a;}
  .muted{color:#64748b;}
  h1{margin:0 0 6px; font-size:20px;}
  .meta{margin:0 0 18px; font-size:12px;}
  .box{border:1px solid #e2e8f0; border-radius:12px; padding:14px; margin:12px 0;}
  table{width:100%; border-collapse:collapse; font-size:12px;}
  th, td{border-bottom:1px solid #e2e8f0; padding:8px 8px; vertical-align:top;}
  th{text-align:left; background:#f8fafc;}
  .right{text-align:right;}
  .best{background:#ecfdf5;}
  .kpi{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
  .kpi .k{border:1px solid #e2e8f0; border-radius:10px; padding:10px 12px; min-width:150px;}
  .kpi .t{font-size:11px; color:#64748b; font-weight:700;}
  .kpi .v{margin-top:6px; font-size:14px; font-weight:800;}
  @media print { .noPrint{display:none;} body{margin:0.5in;} }
</style>
</head>
<body>
  <h1>Customer Quote</h1>
  <p class="meta muted">
    Date: ${now.toLocaleString()}<br/>
    Print size: ${quoteWidth}" × ${quoteHeight}" &nbsp;•&nbsp; Quantity: ${quoteQty}<br/>
    Paper: ${selectedPaperText}<br/>
    Front: ${quoteFrontColorMode.toUpperCase()}${quoteBackEnabled ? " \u00A0\u2022\u00A0 Back: " + quoteBackColorMode.toUpperCase() : ""}<br/>
    ${quoteDocPages > 0 ? `Document pages: ${quoteDocPages}${quoteDocDuplex ? " (duplex)" : ""}` : ""}
  </p>

  <div class="box">
    <div style="font-weight:800;margin-bottom:8px">Best option</div>
    <div class="kpi">
      <div class="k"><div class="t">Sheet</div><div class="v">${best.sheetKey}</div></div>
      ${quoteShowAllPapers ? `<div class="k"><div class="t">Paper</div><div class="v">${best.paperLabel}</div></div>` : ""}
      <div class="k"><div class="t">Total</div><div class="v">$${best.total.toFixed(2)}</div></div>
    </div>
  </div>

  <div class="box">
    <div style="font-weight:800;margin-bottom:8px">Price breakdown</div>
    <table>
      <thead>
        <tr>${tableHeaders.map(h=>`<th>${h}</th>`).join("")}</tr>
      </thead>
      <tbody>
        ${rowHtml}
      </tbody>
    </table>
  </div>

  <button class="noPrint" onclick="window.print()" style="padding:10px 14px;border:0;border-radius:10px;background:#0f172a;color:white;font-weight:700;cursor:pointer">Print</button>
</body>
</html>
          `);
          w.document.close();
          w.focus();
          // Allow the window to render before printing (some browsers need this)
          setTimeout(() => w.print(), 250);
        };

const quoteRows = computeQuickQuoteRows();
        const bestQuote = quoteRows[0] || null;

        const docSheetsNeeded =
          quoteDocPages > 0
            ? Math.ceil(
                quoteDocPages / (quoteDocDuplex ? 2 : 1)
              )
            : 0;

        // ---------- UI ----------

        return (
          <div className="space-y-6 pb-10">
            <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div>
                <h1 className="text-2xl font-bold text-slate-800">
                  The UPS Store Print Layout & Pricing
                </h1>
                <p className="text-sm text-slate-500">
                  Visual layout, accurate pricing, and quick quotes for
                  in-store printing.
                </p>
              </div>
              <div className="flex items-center gap-2">
                <button
                  className={
                    "px-3 py-1.5 text-sm rounded-full border " +
                    (viewMode === "tool"
                      ? "bg-blue-600 text-white border-blue-600"
                      : "bg-white text-slate-700")
                  }
                  onClick={() => setViewMode("tool")}
                >
                  Layout & Pricing
                </button>
                <button
                  className={
                    "px-3 py-1.5 text-sm rounded-full border " +
                    (viewMode === "quote"
                      ? "bg-blue-600 text-white border-blue-600"
                      : "bg-white text-slate-700")
                  }
                  onClick={() => setViewMode("quote")}
                >
                  Quick Quote
                </button>
                <button
                  type="button"
                  onClick={handleAdminClick}
                  className="px-3 py-1.5 text-xs rounded-full border bg-white text-slate-600"
                >
                  {isAdmin
                    ? showAdmin
                      ? "Hide Admin"
                      : "Show Admin"
                    : "Admin / Pricing"}
                </button>
              </div>
            </header>

            {/* MAIN TOOL VIEW */}
            {viewMode === "tool" && (
              <div className="space-y-6">
                {/* Controls row */}
                <section className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 space-y-4">
                  <div className="flex flex-wrap gap-4 items-end">
                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Base Sheet
                      </label>
                      <select
                        value={sheetKey}
                        onChange={(e) => setSheetKey(e.target.value)}
                        className="border rounded-md px-2 py-1 text-sm"
                      >
                        <option value="8.5x11">8.5 × 11 in</option>
                        <option value="11x17">11 × 17 in</option>
                        <option value="12x18">12 × 18 in</option>
                        <option value="custom">Custom…</option>
                      </select>
                    </div>

                    {sheetKey === "custom" && (
                      <div className="flex items-end gap-3">
                        <div>
                          <label className="block text-xs font-medium text-slate-600">
                            Custom Width (in)
                          </label>
                          <input
                            type="number"
                            min="0.1"
                            step="0.01"
                            value={customSize.w}
                            onChange={(e) =>
                              setCustomSize((s) => ({
                                ...s,
                                w: +e.target.value || 0
                              }))
                            }
                            className="border rounded-md px-2 py-1 text-sm w-24"
                          />
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-slate-600">
                            Custom Height (in)
                          </label>
                          <input
                            type="number"
                            min="0.1"
                            step="0.01"
                            value={customSize.h}
                            onChange={(e) =>
                              setCustomSize((s) => ({
                                ...s,
                                h: +e.target.value || 0
                              }))
                            }
                            className="border rounded-md px-2 py-1 text-sm w-24"
                          />
                        </div>
                      </div>
                    )}

                    <div className="space-x-2">
                      <span className="text-xs font-medium text-slate-600">
                        Orientation
                      </span>
                      <button
                        onClick={() => setOrientation("portrait")}
                        className={
                          "px-2 py-1 text-xs rounded-md border " +
                          (orientation === "portrait"
                            ? "bg-blue-50 border-blue-400 text-blue-700"
                            : "bg-white border-slate-200 text-slate-700")
                        }
                      >
                        Portrait
                      </button>
                      <button
                        onClick={() => setOrientation("landscape")}
                        className={
                          "px-2 py-1 text-xs rounded-md border " +
                          (orientation === "landscape"
                            ? "bg-blue-50 border-blue-400 text-blue-700"
                            : "bg-white border-slate-200 text-slate-700")
                        }
                      >
                        Landscape
                      </button>
                    </div>

                    <div className="flex items-end gap-3">
                      <div>
                        <label className="block text-xs font-medium text-slate-600">
                          Print Width (in)
                        </label>
                        <input
                          type="number"
                          value={prints.width}
                          onChange={(e) =>
                            setPrints((p) => ({
                              ...p,
                              width: +e.target.value || 0
                            }))
                          }
                          className="border rounded-md px-2 py-1 text-sm w-24"
                        />
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-slate-600">
                          Print Height (in)
                        </label>
                        <input
                          type="number"
                          value={prints.height}
                          onChange={(e) =>
                            setPrints((p) => ({
                              ...p,
                              height: +e.target.value || 0
                            }))
                          }
                          className="border rounded-md px-2 py-1 text-sm w-24"
                        />
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-slate-600">
                          Quantity
                        </label>
                        <input
                          type="number"
                          value={prints.quantity}
                          onChange={(e) =>
                            setPrints((p) => ({
                              ...p,
                              quantity: +e.target.value || 0
                            }))
                          }
                          className="border rounded-md px-2 py-1 text-sm w-24"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Paper type & options */}
                  <div className="flex flex-wrap items-center justify-between gap-4">
                    <div className="space-y-1">
                      <span className="block text-xs font-medium text-slate-600">
                        Paper Type
                      </span>
                      <div className="flex flex-wrap gap-2">
                        {PAPER_TYPES.map((opt) => (
                          <button
                            key={opt.key}
                            type="button"
                            onClick={() => setPaperKey(opt.key)}
                            className={
                              "px-3 py-1.5 text-xs rounded-full border " +
                              (paperKey === opt.key
                                ? "bg-blue-600 text-white border-blue-600"
                                : "bg-white text-slate-700 border-slate-200")
                            }
                          >
                            {opt.label}
                          </button>
                        ))}
                      </div>
                      {!comboAllowed && (
                        <p className="text-[11px] text-amber-600">
                          {currentPaper.label} is not normally used on{" "}
                          {sheetKey}. Please double-check this combination.
                        </p>
                      )}
                    </div>

                    <div className="flex items-center gap-4 text-xs">
                      <label className="flex items-center gap-1">
                        <input
                          type="checkbox"
                          checked={showBleed}
                          onChange={(e) =>
                            setShowBleed(e.target.checked)
                          }
                        />
                        Full bleed (adds 0.125" on each side)
                      </label>
                      <label className="flex items-center gap-1">
                        <input
                          type="checkbox"
                          checked={showCutLines}
                          onChange={(e) =>
                            setShowCutLines(e.target.checked)
                          }
                        />
                        Show cut boxes
                      </label>
                      <label className="flex items-center gap-1">
                        <input
                          type="checkbox"
                          checked={showGuides}
                          onChange={(e) =>
                            setShowGuides(e.target.checked)
                          }
                        />
                        Show margin guides
                      </label>
                    </div>
                  </div>
                </section>

                {/* PREVIEW + CONTROLS */}
                <section className="grid md:grid-cols-2 gap-6">
                  {/* FRONT */}
                  <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 space-y-3">
                    <div className="flex items-center justify-between">
                      <h2 className="font-semibold text-slate-800 text-sm">
                        Front
                      </h2>
                      <div className="flex items-center gap-3 text-xs">
                        <span className="text-slate-500">
                          Color mode:
                        </span>
                        <button
                          onClick={() =>
                            setFrontColorMode("color")
                          }
                          className={
                            "px-2 py-1 rounded-md border " +
                            (frontColorMode === "color"
                              ? "bg-blue-50 border-blue-400 text-blue-700"
                              : "bg-white border-slate-200 text-slate-700")
                          }
                        >
                          Color
                        </button>
                        <button
                          onClick={() => setFrontColorMode("bw")}
                          className={
                            "px-2 py-1 rounded-md border " +
                            (frontColorMode === "bw"
                              ? "bg-blue-50 border-blue-400 text-blue-700"
                              : "bg-white border-slate-200 text-slate-700")
                          }
                        >
                          B/W
                        </button>
                      </div>
                    </div>

                    <div className="flex flex-wrap items-center gap-3 text-xs">
                      <input
                        type="file"
                        accept="image/*"
                        onChange={(e) => {
                          const f = e.target.files[0];
                          if (!f) return;
                          setFrontImage(f);
                        }}
                        className="border rounded-md px-2 py-1 text-xs"
                      />
                      <button
                        onClick={() =>
                          setFrontRotation((r) => (r + 90) % 360)
                        }
                        className="px-3 py-1 border rounded-md bg-white text-slate-700"
                      >
                        Rotate 90°
                      </button>
                    </div>

                    <canvas
                      ref={frontRef}
                      className="w-full h-auto border border-dashed border-slate-300 rounded-md bg-slate-50"
                    />
                    <p className="text-[11px] text-slate-500">
                      Sheet: {orientedWIn.toFixed(2)}" ×{" "}
                      {orientedHIn.toFixed(2)}" · Margins: 0.1" ·
                      Spacing: 0.05"
                    </p>
                  </div>

                  {/* BACK */}
                  <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 space-y-3">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <h2 className="font-semibold text-slate-800 text-sm">
                          Back
                        </h2>
                        <label className="flex items-center gap-1 text-xs text-slate-600">
                          <input
                            type="checkbox"
                            checked={showBack}
                            onChange={(e) =>
                              setShowBack(e.target.checked)
                            }
                          />
                          Enable
                        </label>
                      </div>
                      <div className="flex items-center gap-3 text-xs">
                        <span className="text-slate-500">
                          Color mode:
                        </span>
                        <button
                          onClick={() => setBackColorMode("color")}
                          disabled={!showBack}
                          className={
                            "px-2 py-1 rounded-md border " +
                            (backColorMode === "color"
                              ? "bg-blue-50 border-blue-400 text-blue-700"
                              : "bg-white border-slate-200 text-slate-700") +
                            (!showBack ? " opacity-50" : "")
                          }
                        >
                          Color
                        </button>
                        <button
                          onClick={() => setBackColorMode("bw")}
                          disabled={!showBack}
                          className={
                            "px-2 py-1 rounded-md border " +
                            (backColorMode === "bw"
                              ? "bg-blue-50 border-blue-400 text-blue-700"
                              : "bg-white border-slate-200 text-slate-700") +
                            (!showBack ? " opacity-50" : "")
                          }
                        >
                          B/W
                        </button>
                      </div>
                    </div>

                    {showBack && (
                      <>
                        <div className="flex flex-wrap items-center gap-3 text-xs">
                          <input
                            type="file"
                            accept="image/*"
                            onChange={(e) => {
                              const f = e.target.files[0];
                              if (!f) return;
                              setBackImage(f);
                            }}
                            className="border rounded-md px-2 py-1 text-xs"
                          />
                          <button
                            onClick={() =>
                              setBackRotation((r) => (r + 90) % 360)
                            }
                            className="px-3 py-1 border rounded-md bg-white text-slate-700"
                          >
                            Rotate 90°
                          </button>
                        </div>
                        <canvas
                          ref={backRef}
                          className="w-full h-auto border border-dashed border-slate-300 rounded-md bg-slate-50"
                        />
                      </>
                    )}

                    {!showBack && (
                      <p className="text-[11px] text-slate-400">
                        Enable back printing to layout the reverse side.
                      </p>
                    )}
                  </div>
                </section>

                {/* SUMMARY + ACTIONS */}
                <section className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 flex flex-wrap items-center justify-between gap-4">
                  <div className="space-y-1 text-sm">
                    <p>
                      <span className="text-slate-500">
                        Sheets needed:
                      </span>{" "}
                      <span className="font-semibold">
                        {sheetsNeeded}
                      </span>
                    </p>
                    <p className="text-xs text-slate-500">
                      Sheet size: {sheetKey} · Paper:{" "}
                      {currentPaper.label}
                    </p>
                    <p className="text-xs text-slate-500">
                      Front per sheet: $
                      {effectiveFrontPerSheet.toFixed(4)} · Back per
                      sheet: ${effectiveBackPerSheet.toFixed(4)} ·
                      Discount factor: {discountFactor.toFixed(3)}
                    </p>
                    <p className="text-base font-semibold text-slate-900">
                      Estimated total: $
                      {totalPrice.toFixed(2)}
                    </p>
                  </div>
                  <div className="flex flex-wrap gap-3">
                    <button
                      onClick={downloadSheetPDF}
                      className="px-4 py-2 rounded-full bg-blue-600 text-white text-sm shadow-sm hover:bg-blue-700"
                    >
                      Download Preview (PDF)
                    </button>
                    <button
                      onClick={orderSheetJob}
                      className="px-4 py-2 rounded-full bg-emerald-600 text-white text-sm shadow-sm hover:bg-emerald-700"
                    >
                      Order Prints (Email to Store)
                    </button>
                  </div>
                </section>

                {/* LARGE FORMAT SECTION */}
                <section className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <h2 className="font-semibold text-slate-800 text-sm">
                      Large Format Printing
                    </h2>
                    <p className="text-xs text-slate-500">
                      Max width: 36"
                    </p>
                  </div>

                  <div className="flex flex-wrap gap-4 items-end text-sm">
                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Width (in)
                      </label>
                      <input
                        type="number"
                        min="1"
                        max="36"
                        value={lfWidth}
                        onChange={(e) =>
                          setLfWidth(
                            Math.min(36, +e.target.value || 1)
                          )
                        }
                        className="border rounded-md px-2 py-1 text-sm w-24"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Height (in)
                      </label>
                      <input
                        type="number"
                        min="1"
                        value={lfHeight}
                        onChange={(e) =>
                          setLfHeight(+e.target.value || 1)
                        }
                        className="border rounded-md px-2 py-1 text-sm w-24"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Paper Type
                      </label>
                      <select
                        value={lfPaperKey}
                        onChange={(e) =>
                          setLfPaperKey(e.target.value)
                        }
                        className="border rounded-md px-2 py-1 text-sm"
                      >
                        {LF_PAPER_TYPES.map((p) => (
                          <option key={p.key} value={p.key}>
                            {p.label}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div className="space-x-2">
                      <span className="text-xs font-medium text-slate-600">
                        Color
                      </span>
                      <button
                        onClick={() => setLfColorMode("color")}
                        className={
                          "px-2 py-1 text-xs rounded-md border " +
                          (lfColorMode === "color"
                            ? "bg-blue-50 border-blue-400 text-blue-700"
                            : "bg-white border-slate-200 text-slate-700")
                        }
                      >
                        Color
                      </button>
                      <button
                        onClick={() => setLfColorMode("bw")}
                        className={
                          "px-2 py-1 text-xs rounded-md border " +
                          (lfColorMode === "bw"
                            ? "bg-blue-50 border-blue-400 text-blue-700"
                            : "bg-white border-slate-200 text-slate-700")
                        }
                      >
                        B/W
                      </button>
                    </div>
                    <label className="flex items-center gap-1 text-xs text-slate-600">
                      <input
                        type="checkbox"
                        checked={lfMaintainProp}
                        onChange={(e) =>
                          setLfMaintainProp(e.target.checked)
                        }
                      />
                      Keep image proportions
                    </label>
                  </div>

                  <div className="flex flex-wrap items-center gap-3 text-xs">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={(e) => {
                        const f = e.target.files[0];
                        if (!f) return;
                        setLfImage(f);
                      }}
                      className="border rounded-md px-2 py-1 text-xs"
                    />
                    <button
                      onClick={() =>
                        setLfRotation((r) => (r + 90) % 360)
                      }
                      className="px-3 py-1 border rounded-md bg-white text-slate-700"
                    >
                      Rotate 90°
                    </button>
                    <label className="flex items-center gap-1">
                      <input
                        type="checkbox"
                        checked={lfGrommets}
                        onChange={(e) =>
                          setLfGrommets(e.target.checked)
                        }
                      />
                      Grommets
                    </label>
                    <label className="flex items-center gap-1">
                      <input
                        type="checkbox"
                        checked={lfFoamCore}
                        onChange={(e) =>
                          setLfFoamCore(e.target.checked)
                        }
                      />
                      Foam Core
                    </label>
                    <label className="flex items-center gap-1">
                      <input
                        type="checkbox"
                        checked={lfCoroSign}
                        onChange={(e) =>
                          setLfCoroSign(e.target.checked)
                        }
                      />
                      Coro Sign
                    </label>
                  </div>

                  <canvas
                    ref={lfRef}
                    className="w-full h-auto border border-dashed border-slate-300 rounded-md bg-slate-50"
                  />

                  <div className="flex flex-wrap items-center justify-between gap-3 text-sm">
                    <div className="space-y-1">
                      <p>
                        Area:{" "}
                        <span className="font-semibold">
                          {lfAreaSqFt.toFixed(2)} sq ft
                        </span>
                      </p>
                      <p className="text-xs text-slate-500">
                        Base per sq ft (with markup): $
                        {lfBase.toFixed(4)} · Add-ons: $
                        {lfAddonTotal.toFixed(2)}
                      </p>
                      <p className="text-base font-semibold text-slate-900">
                        Estimated total: $
                        {lfTotalWithDiscount.toFixed(2)}
                      </p>
                    </div>
                    <div className="flex flex-wrap gap-3">
                      <button
                        onClick={downloadLfPDF}
                        className="px-4 py-2 rounded-full bg-blue-600 text-white text-sm shadow-sm hover:bg-blue-700"
                      >
                        Download Large Format PDF
                      </button>
                      <button
                        onClick={orderLargeFormatJob}
                        className="px-4 py-2 rounded-full bg-emerald-600 text-white text-sm shadow-sm hover:bg-emerald-700"
                      >
                        Order Large Format (Email)
                      </button>
                    </div>
                  </div>
                </section>
                {/* BLUEPRINT SECTION */}
                <section className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <h2 className="font-semibold text-slate-800 text-sm">
                      Blueprint Printing
                    </h2>
                    <p className="text-xs text-slate-500">
                      20lb plain bond only · B/W
                    </p>
                  </div>

                  <div className="flex flex-wrap gap-4 items-end text-sm">
                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Blueprint size
                      </label>
                      <select
                        value={bpSizeKey}
                        onChange={(e) => setBpSizeKey(e.target.value)}
                        className="border rounded-md px-2 py-1 text-sm"
                      >
                        {BLUEPRINT_SIZES.map((s) => (
                          <option key={s.key} value={s.key}>
                            {s.label}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Quantity (sheets)
                      </label>
                      <input
                        type="number"
                        min="1"
                        value={bpQty}
                        onChange={(e) => setBpQty(+e.target.value || 1)}
                        className="border rounded-md px-2 py-1 text-sm w-28"
                      />
                    </div>

                    <label className="flex items-center gap-1 text-xs text-slate-600">
                      <input
                        type="checkbox"
                        checked={bpMaintainProp}
                        onChange={(e) => setBpMaintainProp(e.target.checked)}
                      />
                      Keep image proportions
                    </label>
                  </div>

                  <div className="flex flex-wrap items-center gap-3 text-xs">
                    <input
                      type="file"
                      accept="image/*"
                      onChange={(e) => {
                        const f = e.target.files[0];
                        if (!f) return;
                        setBpImage(f);
                      }}
                      className="border rounded-md px-2 py-1 text-xs"
                    />
                    <button
                      onClick={() => setBpRotation((r) => (r + 90) % 360)}
                      className="px-3 py-1 border rounded-md bg-white text-slate-700"
                    >
                      Rotate 90°
                    </button>
                  </div>

                  <canvas
                    ref={bpRef}
                    className="w-full h-auto border border-dashed border-slate-300 rounded-md bg-slate-50"
                  />

                  <div className="flex flex-wrap items-center justify-between gap-3 text-sm">
                    <div className="space-y-1">
                      <p>
                        Size:{" "}
                        <span className="font-semibold">
                          {bpSize.label}
                        </span>{" "}
                        · Qty:{" "}
                        <span className="font-semibold">{bpQty}</span>
                      </p>
                      <p className="text-xs text-slate-500">
                        Area / sheet: {bpAreaPerSheetSqFt.toFixed(2)} sq ft · PSF: $
                        {bpPsf.toFixed(2)} · Per sheet: $
                        {bpPerSheet.toFixed(2)}
                      </p>
                      <p className="text-base font-semibold text-slate-900">
                        Estimated total: ${bpTotal.toFixed(2)}
                      </p>
                      <p className="text-[11px] text-slate-500">
                        Tier rule is editable in Admin per size (PSF + quantity
                        breaks).
                      </p>
                    </div>
                    <div className="flex flex-wrap gap-3">
                      <button
                        onClick={downloadBlueprintPDF}
                        className="px-4 py-2 rounded-full bg-blue-600 text-white text-sm shadow-sm hover:bg-blue-700"
                      >
                        Download Blueprint PDF
                      </button>
                      <button
                        onClick={orderBlueprintJob}
                        className="px-4 py-2 rounded-full bg-emerald-600 text-white text-sm shadow-sm hover:bg-emerald-700"
                      >
                        Order Blueprints (Email)
                      </button>
                    </div>
                  </div>
                </section>

              </div>
            )}

            {/* QUICK QUOTE VIEW */}
            {viewMode === "quote" && (
              <section className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 space-y-4">
                <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                  <div className="space-y-2">
                    <h2 className="font-semibold text-slate-800 text-sm">
                      Quick Quote (Sheets)
                    </h2>
                    <p className="text-xs text-slate-500 max-w-xl">
                      Enter a print size and quantity, and we’ll show
                      pricing for your selected paper type (or all paper types if enabled), using your current markup and discounts.
                    </p>
                    <p className="text-xs text-slate-600">
                      Showing:{" "}
                      {quoteShowAllPapers
                        ? "All paper types"
                        : (PAPER_TYPES.find((p) => p.key === quotePaperKey) || {})
                            .label}
                    </p>
                    {quoteBackEnabled && (
                      <p className="text-xs text-amber-600">
                        Back printing is enabled for this quote. Make
                        sure the document is prepared as duplex.
                      </p>
                    )}
                  </div>
                  <div className="flex flex-wrap gap-3 text-sm">
                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Paper type
                      </label>
                      <select
                        value={quotePaperKey}
                        onChange={(e) => setQuotePaperKey(e.target.value)}
                        className="border rounded-md px-2 py-1 text-sm"
                      >
                        {PAPER_TYPES.map((pt) => (
                          <option key={pt.key} value={pt.key}>
                            {pt.label}
                          </option>
                        ))}
                      </select>
                      <label className="mt-1 flex items-center gap-2 text-[11px] text-slate-600">
                        <input
                          type="checkbox"
                          checked={quoteShowAllPapers}
                          onChange={(e) =>
                            setQuoteShowAllPapers(e.target.checked)
                          }
                        />
                        Show all paper types
                      </label>
                    </div>

                    <div className="flex items-end">
                      <button
                        type="button"
                        onClick={printQuickQuote}
                        className="px-3 py-2 rounded-full bg-slate-800 text-white text-sm shadow-sm hover:bg-slate-900"
                      >
                        Print Quote
                      </button>
                    </div>

                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Width (in)
                      </label>
                      <input
                        type="number"
                        value={quoteWidth}
                        onChange={(e) =>
                          setQuoteWidth(+e.target.value || 0)
                        }
                        className="border rounded-md px-2 py-1 text-sm w-20"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Height (in)
                      </label>
                      <input
                        type="number"
                        value={quoteHeight}
                        onChange={(e) =>
                          setQuoteHeight(+e.target.value || 0)
                        }
                        className="border rounded-md px-2 py-1 text-sm w-20"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-slate-600">
                        Quantity
                      </label>
                      <input
                        type="number"
                        value={quoteQty}
                        onChange={(e) =>
                          setQuoteQty(+e.target.value || 0)
                        }
                        className="border rounded-md px-2 py-1 text-sm w-24"
                      />
                    </div>
                  </div>
                </div>

                <div className="flex flex-wrap items-center gap-4 text-xs">
                  <div className="flex items-center gap-2">
                    <span className="text-slate-600">
                      Front color:
                    </span>
                    <button
                      onClick={() =>
                        setQuoteFrontColorMode("color")
                      }
                      className={
                        "px-2 py-1 rounded-md border " +
                        (quoteFrontColorMode === "color"
                          ? "bg-blue-50 border-blue-400 text-blue-700"
                          : "bg-white border-slate-200 text-slate-700")
                      }
                    >
                      Color
                    </button>
                    <button
                      onClick={() => setQuoteFrontColorMode("bw")}
                      className={
                        "px-2 py-1 rounded-md border " +
                        (quoteFrontColorMode === "bw"
                          ? "bg-blue-50 border-blue-400 text-blue-700"
                          : "bg-white border-slate-200 text-slate-700")
                      }
                    >
                      B/W
                    </button>
                  </div>
                  <label className="flex items-center gap-1 text-slate-600">
                    <input
                      type="checkbox"
                      checked={quoteBackEnabled}
                      onChange={(e) =>
                        setQuoteBackEnabled(e.target.checked)
                      }
                    />
                    Include back printing
                  </label>
                  {quoteBackEnabled && (
                    <div className="flex items-center gap-2">
                      <span className="text-slate-600">
                        Back color:
                      </span>
                      <button
                        onClick={() =>
                          setQuoteBackColorMode("color")
                        }
                        className={
                          "px-2 py-1 rounded-md border " +
                          (quoteBackColorMode === "color"
                            ? "bg-blue-50 border-blue-400 text-blue-700"
                            : "bg-white border-slate-200 text-slate-700")
                        }
                      >
                        Color
                      </button>
                      <button
                        onClick={() =>
                          setQuoteBackColorMode("bw")
                        }
                        className={
                          "px-2 py-1 rounded-md border " +
                          (quoteBackColorMode === "bw"
                            ? "bg-blue-50 border-blue-400 text-blue-700"
                            : "bg-white border-slate-200 text-slate-700")
                        }
                      >
                        B/W
                      </button>
                    </div>
                  )}
                </div>

                {/* Simple sheet count calculator for duplex docs */}
                <div className="border rounded-xl p-3 bg-slate-50/60 text-xs flex flex-wrap items-end gap-3">
                  <div>
                    <label className="block font-medium text-slate-700">
                      Document pages
                    </label>
                    <input
                      type="number"
                      value={quoteDocPages}
                      onChange={(e) =>
                        setQuoteDocPages(+e.target.value || 0)
                      }
                      className="border rounded-md px-2 py-1 text-xs w-20"
                    />
                  </div>
                  <label className="flex items-center gap-1 text-slate-700">
                    <input
                      type="checkbox"
                      checked={quoteDocDuplex}
                      onChange={(e) =>
                        setQuoteDocDuplex(e.target.checked)
                      }
                    />
                    Print front & back (duplex)
                  </label>
                  <div className="text-slate-700">
                    {quoteDocPages > 0 && (
                      <span>
                        This will use{" "}
                        <span className="font-semibold">
                          {docSheetsNeeded}
                        </span>{" "}
                        sheet
                        {docSheetsNeeded === 1 ? "" : "s"}.
                      </span>
                    )}
                  </div>
                </div>

                {/* Results */}
                <div className="overflow-auto border rounded-xl">
                  <table className="min-w-full text-[11px]">
                    <thead className="bg-slate-100">
                      <tr>
                        {quoteShowAllPapers && (
                          <th className="px-2 py-1 text-left">
                            Paper Type
                          </th>
                        )}
                        <th className="px-2 py-1 text-left">
                          Sheet Size
                        </th>
                        <th className="px-2 py-1 text-right">
                          Prints/Sheet
                        </th>
                        <th className="px-2 py-1 text-right">
                          Sheets Needed
                        </th>
                        <th className="px-2 py-1 text-right">
                          Front/Back per Sheet
                        </th>
                        <th className="px-2 py-1 text-right">
                          Estimated Total
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {quoteRows.length === 0 && (
                        <tr>
                          <td
                            colSpan={6}
                            className="px-3 py-4 text-center text-slate-400"
                          >
                            No valid pricing found. Check your Admin
                            pricing setup.
                          </td>
                        </tr>
                      )}
                      {quoteRows.map((row, idx) => {
                        const isBest =
                          bestQuote &&
                          row.paperLabel === bestQuote.paperLabel &&
                          row.sheetKey === bestQuote.sheetKey &&
                          row.total === bestQuote.total;
                        return (
                          <tr
                            key={idx}
                            className={
                              "border-t " +
                              (isBest
                                ? "bg-emerald-50/60"
                                : "bg-white")
                            }
                          >
                            {quoteShowAllPapers && (
                              <td className="px-2 py-1">
                                {row.paperLabel}
                              </td>
                            )}
                            <td className="px-2 py-1">
                              {row.sheetKey}
                            </td>
                            <td className="px-2 py-1 text-right">
                              {row.printsPer}
                            </td>
                            <td className="px-2 py-1 text-right">
                              {row.sheets}
                            </td>
                            <td className="px-2 py-1 text-right">
                              ${row.perSheetFront.toFixed(4)} / $
                              {row.perSheetBack.toFixed(4)}
                            </td>
                            <td className="px-2 py-1 text-right font-semibold">
                              ${row.total.toFixed(2)}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>

                {bestQuote && (
                  <div className="rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-xs text-emerald-900">
                    Recommended:{" "}
                    <span className="font-semibold">
                      {bestQuote.paperLabel} on {bestQuote.sheetKey}
                    </span>{" "}
                    — {bestQuote.printsPer} per sheet,{" "}
                    {bestQuote.sheets} sheets, approx.{" "}
                    <span className="font-semibold">
                      ${bestQuote.total.toFixed(2)}
                    </span>
                    .
                  </div>
                )}
              </section>
            )}

            {/* ADMIN PANEL */}
            {isAdmin && showAdmin && (
              <section className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 space-y-6">
                <h2 className="text-sm font-semibold text-slate-800">
                  Admin Pricing Panel
                </h2>
                <p className="text-[11px] text-slate-500 max-w-2xl">
                  Password: <code>store4979</code>. Values are stored in
                  this browser (localStorage) and can be exported to a{" "}
                  <code>pricing.json</code> file to reuse across computers
                  or deployments.
                </p>

                {/* Export / Import */}
                <div className="flex flex-wrap items-center gap-3 text-xs">
                  <button
                    type="button"
                    onClick={exportPricingJson}
                    className="px-3 py-1.5 rounded-full bg-slate-800 text-white"
                  >
                    Export pricing.json
                  </button>
                  <label className="flex items-center gap-2">
                    <span className="px-2 py-1.5 rounded-full border border-dashed border-slate-400 cursor-pointer">
                      Import pricing.json
                    </span>
                    <input
                      type="file"
                      accept="application/json"
                      className="hidden"
                      onChange={(e) => {
                        const f = e.target.files[0];
                        if (f) importPricingJson(f);
                        e.target.value = "";
                      }}
                    />
                  </label>
                </div>

                {/* Sheet Base Costs Table */}
                <div className="mb-4 text-xs">
                  <h3 className="font-semibold text-sm mb-1">
                    Sheet Base Costs & Prices
                  </h3>
                  <p className="text-[11px] text-slate-500 mb-2">
                    Base costs are per sheet (color and B/W). Markup is
                    applied on top of these to calculate the price per
                    sheet shown below.
                  </p>
                  <div className="overflow-auto max-h-72 border rounded">
                    <table className="min-w-full text-[11px]">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-2 py-1 text-left">
                            Paper Type
                          </th>
                          <th className="px-2 py-1 text-left">
                            Sheet Size
                          </th>
                          <th className="px-2 py-1 text-right">
                            Base Color Cost
                          </th>
                          <th className="px-2 py-1 text-right">
                            Base B/W Cost
                          </th>
                          <th className="px-2 py-1 text-right">
                            Price Color (with markup)
                          </th>
                          <th className="px-2 py-1 text-right">
                            Price B/W (with markup)
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {PAPER_TYPES.map((pt) =>
                          (SHEET_KEYS_FOR_PAPER[pt.key] || []).map(
                            (sk) => {
                              const raw =
                                (pricing[pt.key] || {})[sk] || {};
                              const entry = normalizeEntry(raw);
                              return (
                                <tr
                                  key={pt.key + "-" + sk}
                                  className="border-t"
                                >
                                  <td className="px-2 py-1">
                                    {pt.label}
                                  </td>
                                  <td className="px-2 py-1">
                                    {sk}
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    <input
                                      type="number"
                                      step="0.0001"
                                      value={entry.baseCostColor}
                                      onChange={(e) => {
                                        const v =
                                          Number(
                                            e.target.value
                                          ) || 0;
                                        setPricing((prev) => {
                                          const next = {
                                            ...prev
                                          };
                                          const group =
                                            next[pt.key] || {};
                                          const norm =
                                            normalizeEntry(
                                              group[sk] || {}
                                            );
                                          if (!next[pt.key])
                                            next[pt.key] = {};
                                          next[pt.key][sk] = {
                                            ...norm,
                                            baseCostColor: v
                                          };
                                          return next;
                                        });
                                      }}
                                      className="border rounded px-1 py-0.5 w-20 text-right"
                                    />
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    <input
                                      type="number"
                                      step="0.0001"
                                      value={entry.baseCostBW}
                                      onChange={(e) => {
                                        const v =
                                          Number(
                                            e.target.value
                                          ) || 0;
                                        setPricing((prev) => {
                                          const next = {
                                            ...prev
                                          };
                                          const group =
                                            next[pt.key] || {};
                                          const norm =
                                            normalizeEntry(
                                              group[sk] || {}
                                            );
                                          if (!next[pt.key])
                                            next[pt.key] = {};
                                          next[pt.key][sk] = {
                                            ...norm,
                                            baseCostBW: v
                                          };
                                          return next;
                                        });
                                      }}
                                      className="border rounded px-1 py-0.5 w-20 text-right"
                                    />
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    $
                                    {entry.priceColor.toFixed(
                                      4
                                    )}
                                  </td>
                                  <td className="px-2 py-1 text-right">
                                    $
                                    {entry.priceBW.toFixed(4)}
                                  </td>
                                </tr>
                              );
                            }
                          )
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Sheet Markup */}
                <div className="border-t pt-4 grid md:grid-cols-2 gap-6 text-xs">
                  <div>
                    <h3 className="font-semibold text-sm mb-2">
                      Sheet Markups (%)
                    </h3>
                    <div className="space-y-2">
                      {PAPER_TYPES.map((pt) => (
                        <div
                          key={pt.key}
                          className="flex items-center justify-between gap-2"
                        >
                          <span>{pt.label}</span>
                          <div className="flex items-center gap-2">
                            <input
                              type="number"
                              step="0.1"
                              value={markupPerPaper[pt.key] || 0}
                              onChange={(e) =>
                                setMarkupPerPaper((prev) => ({
                                  ...prev,
                                  [pt.key]:
                                    e.target.value === ""
                                      ? ""
                                      : +e.target.value || 0
                                }))
                              }
                              className="border rounded px-1 py-0.5 w-16 text-right"
                            />
                            <span>%</span>
                            <button
                              type="button"
                              onClick={() =>
                                applyMarkupForPaper(pt.key)
                              }
                              className="px-2 py-0.5 border rounded bg-slate-100"
                            >
                              Apply
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                    <button
                      type="button"
                      onClick={applyMarkupForAllPapers}
                      className="mt-3 px-3 py-1.5 rounded-full bg-slate-800 text-white"
                    >
                      Apply all sheet markups
                    </button>
                  </div>

                  {/* Quantity discounts + back factor */}
                  <div className="space-y-3">
                    <div>
                      <h3 className="font-semibold text-sm mb-1">
                        Sheet Quantity Discounts
                      </h3>
                      <p className="text-[11px] text-slate-500 mb-2">
                        Discounts apply based on the number of sheets
                        (not prints).
                      </p>
                      <div className="space-y-1">
                        {quantityDiscounts.map((row, idx) => (
                          <div
                            key={idx}
                            className="flex items-center gap-2"
                          >
                            <span className="text-slate-600">
                              ≥
                            </span>
                            <input
                              type="number"
                              value={row.minSheets}
                              onChange={(e) => {
                                const v =
                                  +e.target.value || 0;
                                setQuantityDiscounts(
                                  (prev) => {
                                    const copy =
                                      [...prev];
                                    copy[idx] = {
                                      ...copy[idx],
                                      minSheets: v
                                    };
                                    return copy;
                                  }
                                );
                              }}
                              className="border rounded px-1 py-0.5 w-16 text-right"
                            />
                            <span className="text-slate-600">
                              sheets →
                            </span>
                            <input
                              type="number"
                              value={row.discountPercent}
                              onChange={(e) => {
                                const v =
                                  +e.target.value || 0;
                                setQuantityDiscounts(
                                  (prev) => {
                                    const copy =
                                      [...prev];
                                    copy[idx] = {
                                      ...copy[idx],
                                      discountPercent:
                                        v
                                    };
                                    return copy;
                                  }
                                );
                              }}
                              className="border rounded px-1 py-0.5 w-16 text-right"
                            />
                            <span>% off</span>
                            <button
                              type="button"
                              onClick={() =>
                                setQuantityDiscounts(
                                  (prev) =>
                                    prev.filter(
                                      (_, i) =>
                                        i !== idx
                                    )
                                )
                              }
                              className="text-red-500"
                            >
                              ✕
                            </button>
                          </div>
                        ))}
                      </div>
                      <button
                        type="button"
                        onClick={() =>
                          setQuantityDiscounts((prev) => [
                            ...prev,
                            {
                              minSheets: 0,
                              discountPercent: 0
                            }
                          ])
                        }
                        className="mt-2 text-xs text-blue-600"
                      >
                        + Add discount tier
                      </button>
                    </div>

                    <div>
                      <h3 className="font-semibold text-sm mb-1">
                        Back-side Price Factor
                      </h3>
                      <p className="text-[11px] text-slate-500 mb-1">
                        Multiplier applied to the per-sheet price when
                        back printing is enabled. Example: 0.5 → front
                        + half-price back.
                      </p>
                      <input
                        type="number"
                        step="0.05"
                        value={backSideFactor}
                        onChange={(e) =>
                          setBackSideFactor(
                            parseFloat(e.target.value) || 0
                          )
                        }
                        className="border rounded px-2 py-1 text-xs w-24"
                      />
                    </div>
                  </div>
                </div>

                {/* LARGE FORMAT ADMIN */}
                <div className="border-t pt-4 grid md:grid-cols-2 gap-6 text-xs">
                  <div>
                    <h3 className="font-semibold text-sm mb-2">
                      Large Format Base Costs & Markups
                    </h3>
                    <div className="overflow-auto max-h-72 border rounded">
                      <table className="min-w-full text-[11px]">
                        <thead className="bg-gray-100">
                          <tr>
                            <th className="px-2 py-1 text-left">
                              Paper
                            </th>
                            <th className="px-2 py-1 text-right">
                              Base Color / sq ft
                            </th>
                            <th className="px-2 py-1 text-right">
                              Base B/W / sq ft
                            </th>
                            <th className="px-2 py-1 text-right">
                              Price Color
                            </th>
                            <th className="px-2 py-1 text-right">
                              Price B/W
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          {LF_PAPER_TYPES.map((pt) => {
                            const entry = normalizeEntry(
                              lfPricing[pt.key] || {}
                            );
                            return (
                              <tr
                                key={pt.key}
                                className="border-t"
                              >
                                <td className="px-2 py-1">
                                  {pt.label}
                                </td>
                                <td className="px-2 py-1 text-right">
                                  <input
                                    type="number"
                                    step="0.0001"
                                    value={
                                      entry.baseCostColor
                                    }
                                    onChange={(e) => {
                                      const v =
                                        Number(
                                          e.target
                                            .value
                                        ) || 0;
                                      setLfPricing(
                                        (prev) => {
                                          const next =
                                            {
                                              ...prev
                                            };
                                          const norm =
                                            normalizeEntry(
                                              next[
                                                pt
                                                  .key
                                              ] ||
                                                {}
                                            );
                                          next[
                                            pt.key
                                          ] = {
                                            ...norm,
                                            baseCostColor:
                                              v
                                          };
                                          return next;
                                        }
                                      );
                                    }}
                                    className="border rounded px-1 py-0.5 w-20 text-right"
                                  />
                                </td>
                                <td className="px-2 py-1 text-right">
                                  <input
                                    type="number"
                                    step="0.0001"
                                    value={entry.baseCostBW}
                                    onChange={(e) => {
                                      const v =
                                        Number(
                                          e.target
                                            .value
                                        ) || 0;
                                      setLfPricing(
                                        (prev) => {
                                          const next =
                                            {
                                              ...prev
                                            };
                                          const norm =
                                            normalizeEntry(
                                              next[
                                                pt
                                                  .key
                                              ] ||
                                                {}
                                            );
                                          next[
                                            pt.key
                                          ] = {
                                            ...norm,
                                            baseCostBW: v
                                          };
                                          return next;
                                        }
                                      );
                                    }}
                                    className="border rounded px-1 py-0.5 w-20 text-right"
                                  />
                                </td>
                                <td className="px-2 py-1 text-right">
                                  $
                                  {entry.priceColor.toFixed(
                                    4
                                  )}
                                </td>
                                <td className="px-2 py-1 text-right">
                                  $
                                  {entry.priceBW.toFixed(4)}
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>

                    <div className="mt-3 space-y-1">
                      <h4 className="font-semibold text-xs">
                        Large Format Markup (% per paper)
                      </h4>
                      {LF_PAPER_TYPES.map((pt) => (
                        <div
                          key={pt.key}
                          className="flex items-center justify-between gap-2"
                        >
                          <span>{pt.label}</span>
                          <div className="flex items-center gap-2">
                            <input
                              type="number"
                              step="0.1"
                              value={lfMarkupPerPaper[pt.key] || 0}
                              onChange={(e) =>
                                setLfMarkupPerPaper((prev) => ({
                                  ...prev,
                                  [pt.key]:
                                    e.target.value === ""
                                      ? ""
                                      : +e.target.value || 0
                                }))
                              }
                              className="border rounded px-1 py-0.5 w-16 text-right"
                            />
                            <span>%</span>
                            <button
                              type="button"
                              onClick={() =>
                                applyLfMarkupForPaper(pt.key)
                              }
                              className="px-2 py-0.5 border rounded bg-slate-100"
                            >
                              Apply
                            </button>
                          </div>
                        </div>
                      ))}
                      <button
                        type="button"
                        onClick={applyLfMarkupForAll}
                        className="mt-2 px-3 py-1.5 rounded-full bg-slate-800 text-white"
                      >
                        Apply all large-format markups
                      </button>
                    </div>
                  </div>

                  {/* LF add-ons */}
                  <div className="space-y-3">
                    <div>
                      <h3 className="font-semibold text-sm mb-1">
                        Large Format Add-ons
                      </h3>
                      <p className="text-[11px] text-slate-500 mb-2">
                        These costs are added on top of the base large
                        format price when the corresponding option is
                        checked.
                      </p>
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <span className="w-24">Grommets:</span>
                          <input
                            type="number"
                            step="0.01"
                            value={lfAddonPricing.grommets || 0}
                            onChange={(e) =>
                              setLfAddonPricing((prev) => ({
                                ...prev,
                                grommets:
                                  Number(e.target.value) || 0
                              }))
                            }
                            className="border rounded px-2 py-1 text-xs w-24 text-right"
                          />
                          <span className="text-slate-500 text-[11px]">
                            (per job)
                          </span>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="w-24">Foam Core:</span>
                          <input
                            type="number"
                            step="0.01"
                            value={lfAddonPricing.foamCore || 0}
                            onChange={(e) =>
                              setLfAddonPricing((prev) => ({
                                ...prev,
                                foamCore:
                                  Number(e.target.value) || 0
                              }))
                            }
                            className="border rounded px-2 py-1 text-xs w-24 text-right"
                          />
                          <span className="text-slate-500 text-[11px]">
                            (per job)
                          </span>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="w-24">Coro Sign:</span>
                          <input
                            type="number"
                            step="0.01"
                            value={lfAddonPricing.coroSign || 0}
                            onChange={(e) =>
                              setLfAddonPricing((prev) => ({
                                ...prev,
                                coroSign:
                                  Number(e.target.value) || 0
                              }))
                            }
                            className="border rounded px-2 py-1 text-xs w-24 text-right"
                          />
                          <span className="text-slate-500 text-[11px]">
                            (per job)
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                {/* BLUEPRINT PRICING */}
                <div className="border-t pt-4 text-xs">
                  <div className="flex flex-wrap items-end justify-between gap-3">
                    <div>
                      <h3 className="font-semibold text-sm mb-1">
                        Blueprint Pricing (20lb Plain Bond Only)
                      </h3>
                      <p className="text-[11px] text-slate-500">
                        Edit price per square foot (PSF) and the sheet-quantity breaks for each blueprint size.
                        Tier 4 is always open-ended (everything above Tier 3).
                      </p>
                    </div>
                    <button
                      type="button"
                      onClick={() => setBpPricing(buildInitialBlueprintPricing())}
                      className="px-3 py-1.5 rounded-full bg-slate-800 text-white"
                    >
                      Reset blueprint defaults
                    </button>
                  </div>

                  <div className="mt-3 overflow-auto max-h-80 border rounded">
                    <table className="min-w-full text-[11px]">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-2 py-1 text-left">Size</th>
                          <th className="px-2 py-1 text-right">Area (sq ft)</th>

                          <th className="px-2 py-1 text-right">Tier 1 max qty</th>
                          <th className="px-2 py-1 text-right">Tier 1 PSF</th>

                          <th className="px-2 py-1 text-right">Tier 2 max qty</th>
                          <th className="px-2 py-1 text-right">Tier 2 PSF</th>

                          <th className="px-2 py-1 text-right">Tier 3 max qty</th>
                          <th className="px-2 py-1 text-right">Tier 3 PSF</th>

                          <th className="px-2 py-1 text-right">Tier 4+ PSF</th>
                        </tr>
                      </thead>
                      <tbody>
                        {BLUEPRINT_SIZES.map((s) => {
                          const area = (s.w * s.h) / 144;
                          const cfg = (bpPricing || {})[s.key] || {};
                          const tiers = Array.isArray(cfg.tiers) ? cfg.tiers : [];
                          const t0 = tiers[0] || { maxQty: "", psf: 0 };
                          const t1 = tiers[1] || { maxQty: "", psf: 0 };
                          const t2 = tiers[2] || { maxQty: "", psf: 0 };
                          const t3 = tiers[3] || { maxQty: null, psf: 0 };

                          const updateTier = (tierIdx, patch) => {
                            setBpPricing((prev) => {
                              const next = { ...(prev || {}) };
                              const cur = next[s.key] || { tiers: [] };
                              const curTiers = Array.isArray(cur.tiers) ? [...cur.tiers] : [];
                              while (curTiers.length < 4) curTiers.push({ maxQty: null, psf: 0 });
                              curTiers[tierIdx] = { ...curTiers[tierIdx], ...patch };
                              // keep tier 4 open-ended
                              curTiers[3] = { ...curTiers[3], maxQty: null };
                              next[s.key] = { ...cur, tiers: curTiers };
                              return next;
                            });
                          };

                          return (
                            <tr key={s.key} className="border-t">
                              <td className="px-2 py-1">{s.label}</td>
                              <td className="px-2 py-1 text-right">{area.toFixed(2)}</td>

                              <td className="px-2 py-1 text-right">
                                <input
                                  type="number"
                                  value={t0.maxQty ?? ""}
                                  onChange={(e) =>
                                    updateTier(0, { maxQty: +e.target.value || 0 })
                                  }
                                  className="border rounded px-1 py-0.5 w-20 text-right"
                                />
                              </td>
                              <td className="px-2 py-1 text-right">
                                <input
                                  type="number"
                                  step="0.01"
                                  value={Number(t0.psf) || 0}
                                  onChange={(e) =>
                                    updateTier(0, { psf: Number(e.target.value) || 0 })
                                  }
                                  className="border rounded px-1 py-0.5 w-20 text-right"
                                />
                              </td>

                              <td className="px-2 py-1 text-right">
                                <input
                                  type="number"
                                  value={t1.maxQty ?? ""}
                                  onChange={(e) =>
                                    updateTier(1, { maxQty: +e.target.value || 0 })
                                  }
                                  className="border rounded px-1 py-0.5 w-20 text-right"
                                />
                              </td>
                              <td className="px-2 py-1 text-right">
                                <input
                                  type="number"
                                  step="0.01"
                                  value={Number(t1.psf) || 0}
                                  onChange={(e) =>
                                    updateTier(1, { psf: Number(e.target.value) || 0 })
                                  }
                                  className="border rounded px-1 py-0.5 w-20 text-right"
                                />
                              </td>

                              <td className="px-2 py-1 text-right">
                                <input
                                  type="number"
                                  value={t2.maxQty ?? ""}
                                  onChange={(e) =>
                                    updateTier(2, { maxQty: +e.target.value || 0 })
                                  }
                                  className="border rounded px-1 py-0.5 w-20 text-right"
                                />
                              </td>
                              <td className="px-2 py-1 text-right">
                                <input
                                  type="number"
                                  step="0.01"
                                  value={Number(t2.psf) || 0}
                                  onChange={(e) =>
                                    updateTier(2, { psf: Number(e.target.value) || 0 })
                                  }
                                  className="border rounded px-1 py-0.5 w-20 text-right"
                                />
                              </td>

                              <td className="px-2 py-1 text-right">
                                <span className="text-slate-500">+</span>
                              </td>
                              <td className="px-2 py-1 text-right">
                                <input
                                  type="number"
                                  step="0.01"
                                  value={Number(t3.psf) || 0}
                                  onChange={(e) =>
                                    updateTier(3, { psf: Number(e.target.value) || 0 })
                                  }
                                  className="border rounded px-1 py-0.5 w-20 text-right"
                                />
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>

                </div>
              </section>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(
        <PriceCalculatorApp />
      );
    </script>
  </body>
</html>
